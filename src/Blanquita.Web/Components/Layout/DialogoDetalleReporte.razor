@using Blanquita.Application.DTOs

<MudDialog>
    <DialogContent>
        <MudGrid>
            <!-- Encabezado con información del reporte -->
            <MudItem xs="12">
                <MudPaper Elevation="0" Class="pa-3" Style="background-color: #f5f5f5;">
                    <MudGrid>
                        <MudItem xs="6" md="3">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Sucursal</MudText>
                            <MudText Typo="Typo.body1"><strong>@Reporte.Sucursal</strong></MudText>
                        </MudItem>
                        <MudItem xs="6" md="3">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Fecha</MudText>
                            <MudText Typo="Typo.body1"><strong>@Reporte.Fecha.ToString("dd/MM/yyyy")</strong></MudText>
                        </MudItem>
                        <MudItem xs="6" md="3">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Total Sistema</MudText>
                            <MudText Typo="Typo.body1">
                                <strong>@Reporte.TotalSistema.ToString("C2", new System.Globalization.CultureInfo("es-MX"))</strong>
                            </MudText>
                        </MudItem>
                        <MudItem xs="6" md="3">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Total Manual</MudText>
                            <MudText Typo="Typo.body1">
                                <strong>@Reporte.TotalCorteManual.ToString("C2", new System.Globalization.CultureInfo("es-MX"))</strong>
                            </MudText>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Diferencia</MudText>
                            <MudText Typo="Typo.h6" Color="@ObtenerColorDiferencia(Reporte.Diferencia)">
                                <strong>@Reporte.Diferencia.ToString("C2", new System.Globalization.CultureInfo("es-MX"))</strong>
                            </MudText>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Generado el</MudText>
                            <MudText Typo="Typo.body1">@Reporte.FechaGeneracion.ToString("dd/MM/yyyy HH:mm:ss")</MudText>
                        </MudItem>
                        
                        @if (!string.IsNullOrWhiteSpace(Reporte.Notas))
                        {
                            <MudItem xs="12">
                                <MudDivider Class="my-2" />
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Notas</MudText>
                                <MudText Typo="Typo.body2">@Reporte.Notas</MudText>
                            </MudItem>
                        }
                    </MudGrid>
                </MudPaper>
            </MudItem>

            <!-- Tabla de detalles -->
            <MudItem xs="12">
                @if (Reporte.Detalles != null && Reporte.Detalles.Any())
                {
                    <MudTable Items="@Reporte.Detalles.OrderBy(x => x.Caja)"
                              Dense="true"
                              Hover="true"
                              Striped="true"
                              Elevation="0"
                              Style="border: 1px solid #e0e0e0;">
                        <HeaderContent>
                            <MudTh Style="font-weight: bold;">Fecha</MudTh>
                            <MudTh Style="font-weight: bold;">Caja</MudTh>
                            <MudTh Style="font-weight: bold; text-align: right;">Facturado</MudTh>
                            <MudTh Style="font-weight: bold; text-align: right;">Devolución</MudTh>
                            <MudTh Style="font-weight: bold; text-align: right;">Venta Global</MudTh>
                            <MudTh Style="font-weight: bold; text-align: right;">Total</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Fecha">@context.Fecha</MudTd>
                            <MudTd DataLabel="Caja">
                                <MudChip T="string" Size="Size.Small" Color="Color.Primary">@context.Caja</MudChip>
                            </MudTd>
                            <MudTd DataLabel="Facturado" Style="text-align: right;">
                                @context.Facturado.ToString("C2", new System.Globalization.CultureInfo("es-MX"))
                            </MudTd>
                            <MudTd DataLabel="Devolución" Style="text-align: right;">
                                <MudText Color="Color.Error">
                                    @context.Devolucion.ToString("C2", new System.Globalization.CultureInfo("es-MX"))
                                </MudText>
                            </MudTd>
                            <MudTd DataLabel="Venta Global" Style="text-align: right;">
                                @context.VentaGlobal.ToString("C2", new System.Globalization.CultureInfo("es-MX"))
                            </MudTd>
                            <MudTd DataLabel="Total" Style="text-align: right;">
                                <strong>@context.Total.ToString("C2", new System.Globalization.CultureInfo("es-MX"))</strong>
                            </MudTd>
                        </RowTemplate>
                        <FooterContent>
                            <MudTh Style="font-weight: bold; background-color: #f5f5f5;" colspan="2">TOTALES</MudTh>
                            <MudTh Style="font-weight: bold; text-align: right; background-color: #f5f5f5;">
                                @Reporte.Detalles.Sum(x => x.Facturado).ToString("C2", new System.Globalization.CultureInfo("es-MX"))
                            </MudTh>
                            <MudTh Style="font-weight: bold; text-align: right; background-color: #f5f5f5;">
                                <MudText Color="Color.Error">
                                    @Reporte.Detalles.Sum(x => x.Devolucion).ToString("C2", new System.Globalization.CultureInfo("es-MX"))
                                </MudText>
                            </MudTh>
                            <MudTh Style="font-weight: bold; text-align: right; background-color: #f5f5f5;">
                                @Reporte.Detalles.Sum(x => x.VentaGlobal).ToString("C2", new System.Globalization.CultureInfo("es-MX"))
                            </MudTh>
                            <MudTh Style="font-weight: bold; text-align: right; background-color: #f5f5f5;">
                                @Reporte.TotalSistema.ToString("C2", new System.Globalization.CultureInfo("es-MX"))
                            </MudTh>
                        </FooterContent>
                    </MudTable>

                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                        Total de registros: @Reporte.Detalles.Count
                    </MudText>
                }
                else
                {
                    <MudAlert Severity="Severity.Info">
                        No hay detalles disponibles para este reporte
                    </MudAlert>
                }
            </MudItem>
        </MudGrid>
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="Close">Cerrar</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter] 
    public ReporteDto Reporte { get; set; } = default!;

    private void Close() => MudDialog.Close();

    private Color ObtenerColorDiferencia(decimal diferencia)
    {
        if (diferencia == 0) return Color.Success;
        if (diferencia > 0) return Color.Info;
        return Color.Warning;
    }
}