@page "/reportes"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@using System.ComponentModel.DataAnnotations
@using Blanquita.Application.Interfaces
@using Blanquita.Application.Interfaces.Repositories
@using Blanquita.Application.DTOs
@using Blanquita.Domain.Entities
@using Blanquita.Domain.ValueObjects
@inject IReporteHistoricoService ReporteService
@inject IReportGeneratorService ReportGeneratorService
@inject IFoxProDiagnosticService DiagnosticService
@inject IExportService ExportService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IJSRuntime JS
@inject ILogger<Reportes> Logger
@inject IBranchService BranchService

<PageTitle>Generar Reportes - Sistema de Reportes</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4 animate-fade-in">
    <MudText Typo="Typo.h4" Class="mb-6 font-weight-bold" Style="background: linear-gradient(45deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
        <MudIcon Icon="@Icons.Material.Filled.Receipt" Class="mr-2" Size="Size.Large" Color="Color.Primary" />
        Generar Reporte de Facturación
    </MudText>

    <MudGrid>
        <!-- Formulario de parámetros -->
        <MudItem xs="12" md="4">
            <MudCard Elevation="4" Class="rounded-lg">
                <MudCardContent Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-4" Color="Color.Primary">
                        <MudIcon Icon="@Icons.Material.Filled.FilterAlt" Size="Size.Small" Class="mr-2" />
                        Parámetros del Reporte
                    </MudText>

                    <MudSelect T="BranchDto" @bind-Value="sucursalSeleccionada"
                               Label="Sucursal"
                               Variant="Variant.Outlined"
                               Required="true"
                               Class="mb-3"
                               ToStringFunc="@(b => b?.Name)"
                               AnchorOrigin="Origin.BottomCenter">
                        @if (sucursales != null)
                        {
                            @foreach (var suc in sucursales)
                            {
                                <MudSelectItem Value="@suc">@suc.Name</MudSelectItem>
                            }
                        }
                    </MudSelect>

                    <MudDatePicker @bind-Date="fechaSeleccionada"
                                   Label="Fecha del Reporte"
                                   Variant="Variant.Outlined"
                                   Required="true"
                                   MaxDate="DateTime.Today"
                                   Class="mb-3" />

                    <MudDivider Class="my-3" />

                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               FullWidth="true"
                               StartIcon="@Icons.Material.Filled.PlayArrow"
                               OnClick="GenerarReporte"
                               Disabled="@(generando || sucursalSeleccionada == null || fechaSeleccionada == null)"
                               Size="Size.Large"
                               Class="py-2">
                        @if (generando)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <text>Generando...</text>
                        }
                        else
                        {
                            <text>Generar Reporte</text>
                        }
                    </MudButton>

                    @if (reporteGenerado && datosReporte != null && datosReporte.Any())
                    {
                        <MudDivider Class="my-3" />

                        <MudText Typo="Typo.subtitle1" Class="mb-2 font-weight-bold">
                            <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Class="mr-2" />
                            Corte Manual
                        </MudText>

                        <MudNumericField @bind-Value="totalCorteManual"
                                         Label="Total Corte Manual"
                                         Variant="Variant.Outlined"
                                         Format="N2"
                                         Culture="@(new System.Globalization.CultureInfo("es-MX"))"
                                         Adornment="Adornment.Start"
                                         AdornmentIcon="@Icons.Material.Filled.AttachMoney"
                                         OnBlur="CalcularDiferencia"
                                         Class="mb-2" />

                        @if (totalCorteManual.HasValue)
                        {
                            var diferencia = totalCorteManual.Value - totalSistema;
                            var colorDiferencia = diferencia == 0 ? Color.Success : (diferencia > 0 ? Color.Info : Color.Warning);

                            <MudAlert Severity="@(diferencia == 0 ? Severity.Success : Severity.Warning)"
                                      Dense="true"
                                      Class="mb-2 rounded-lg"
                                      Variant="Variant.Filled">
                                <MudText Typo="Typo.body2">
                                    <strong>Diferencia:</strong> @diferencia.ToString("C2", new System.Globalization.CultureInfo("es-MX"))
                                </MudText>
                                <MudText Typo="Typo.body2">
                                    <strong>Sistema:</strong> @totalSistema.ToString("C2", new System.Globalization.CultureInfo("es-MX"))
                                </MudText>
                            </MudAlert>
                        }

                        <MudTextField @bind-Value="notasReporte"
                                      Label="Notas del Reporte"
                                      Variant="Variant.Outlined"
                                      Lines="3"
                                      Class="mb-3" />
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Resultados -->
        <MudItem xs="12" md="8">
            @if (generando)
            {
                <MudCard Elevation="4" Class="rounded-lg pa-8 text-center animate-fade-in">
                    <MudCardContent>
                        <MudProgressCircular Size="Size.Large" Indeterminate="true" Color="Color.Primary" />
                        <MudText Typo="Typo.h6" Class="mt-4">Generando reporte...</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            Procesando datos de @sucursalSeleccionada?.Name para @fechaSeleccionada?.ToString("dd/MM/yyyy")
                        </MudText>
                    </MudCardContent>
                </MudCard>
            }
            else if (reporteGenerado && datosReporte != null)
            {
                <MudCard Elevation="4" Class="rounded-lg animate-slide-up">
                    <MudCardContent Class="pa-4">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                            <MudText Typo="Typo.h6" Color="Color.Primary">
                                <MudIcon Icon="@Icons.Material.Filled.TableChart" Class="mr-2" />
                                Resultados - @sucursalReporte?.Name (@fechaReporte?.ToString("dd/MM/yyyy"))
                            </MudText>

                            <MudStack Row="true" Spacing="2">
                                <MudButton Variant="Variant.Outlined"
                                           StartIcon="@Icons.Material.Filled.Download"
                                           Color="Color.Success"
                                           OnClick="ExportarExcel"
                                           Size="Size.Small">
                                    Excel
                                </MudButton>
                                <MudButton Variant="Variant.Outlined"
                                           StartIcon="@Icons.Material.Filled.PictureAsPdf"
                                           Color="Color.Error"
                                           OnClick="ExportarPDF"
                                           Size="Size.Small">
                                    PDF
                                </MudButton>
                                <MudButton Variant="Variant.Filled"
                                           StartIcon="@Icons.Material.Filled.Save"
                                           Color="Color.Primary"
                                           OnClick="GuardarEnHistorico"
                                           Disabled="@guardando"
                                           Size="Size.Small">
                                    @if (guardando)
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-1" />
                                    }
                                    Guardar
                                </MudButton>
                            </MudStack>
                        </MudStack>

                        @if (datosReporte.Any())
                        {
                            <MudTable Items="@datosReporte.OrderBy(x => x.Caja)"
                                      Dense="true"
                                      Hover="true"
                                      Striped="true"
                                      Elevation="0"
                                      Bordered="true">
                                <HeaderContent>
                                    <MudTh Style="font-weight: bold;">Fecha</MudTh>
                                    <MudTh Style="font-weight: bold;">Caja</MudTh>
                                    <MudTh Style="font-weight: bold; text-align: right;">Facturado</MudTh>
                                    <MudTh Style="font-weight: bold; text-align: right;">Devolución</MudTh>
                                    <MudTh Style="font-weight: bold; text-align: right;">Venta Global</MudTh>
                                    <MudTh Style="font-weight: bold; text-align: right;">Total</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Fecha">@context.Fecha</MudTd>
                                    <MudTd DataLabel="Caja">
                                        <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined">@context.Caja</MudChip>
                                    </MudTd>
                                    <MudTd DataLabel="Facturado" Style="text-align: right;">
                                        @context.Facturado.ToString("C2", new System.Globalization.CultureInfo("es-MX"))
                                    </MudTd>
                                    <MudTd DataLabel="Devolución" Style="text-align: right;">
                                        <MudText Color="Color.Error">
                                            @context.Devolucion.ToString("C2", new System.Globalization.CultureInfo("es-MX"))
                                        </MudText>
                                    </MudTd>
                                    <MudTd DataLabel="Venta Global" Style="text-align: right;">
                                        @context.VentaGlobal.ToString("C2", new System.Globalization.CultureInfo("es-MX"))
                                    </MudTd>
                                    <MudTd DataLabel="Total" Style="text-align: right;">
                                        <strong>@context.Total.ToString("C2", new System.Globalization.CultureInfo("es-MX"))</strong>
                                    </MudTd>
                                </RowTemplate>
                                <FooterContent>
                                    <MudTh Style="font-weight: bold; background-color: #f5f5f5;" colspan="2">TOTALES</MudTh>
                                    <MudTh Style="font-weight: bold; text-align: right; background-color: #f5f5f5;">
                                        @datosReporte.Sum(x => x.Facturado).ToString("C2", new System.Globalization.CultureInfo("es-MX"))
                                    </MudTh>
                                    <MudTh Style="font-weight: bold; text-align: right; background-color: #f5f5f5;">
                                        <MudText Color="Color.Error">
                                            @datosReporte.Sum(x => x.Devolucion).ToString("C2", new System.Globalization.CultureInfo("es-MX"))
                                        </MudText>
                                    </MudTh>
                                    <MudTh Style="font-weight: bold; text-align: right; background-color: #f5f5f5;">
                                        @datosReporte.Sum(x => x.VentaGlobal).ToString("C2", new System.Globalization.CultureInfo("es-MX"))
                                    </MudTh>
                                    <MudTh Style="font-weight: bold; text-align: right; background-color: #f5f5f5;">
                                        @totalSistema.ToString("C2", new System.Globalization.CultureInfo("es-MX"))
                                    </MudTh>
                                </FooterContent>
                            </MudTable>

                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2 d-block text-right">
                                Total de registros: @datosReporte.Count
                            </MudText>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info" Class="mt-2 rounded-lg">
                                No se encontraron datos para la sucursal <strong>@sucursalReporte?.Name</strong> en la fecha <strong>@fechaReporte?.ToString("dd/MM/yyyy")</strong>
                            </MudAlert>
                        }
                    </MudCardContent>
                </MudCard>
            }
            else
            {
                <MudCard Elevation="4" Class="rounded-lg pa-8 text-center animate-fade-in" Style="min-height: 400px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <MudCardContent>
                        <MudIcon Icon="@Icons.Material.Filled.Assessment" Size="Size.Large" Color="Color.Secondary" Style="font-size: 4rem; opacity: 0.3;" />
                        <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mt-4 font-weight-bold">
                            Seleccione los parámetros y genere un reporte
                        </MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            Elija una sucursal y fecha para comenzar
                        </MudText>
                    </MudCardContent>
                </MudCard>
            }
        </MudItem>
    </MudGrid>
</MudContainer>

<style>
    .animate-fade-in {
        animation: fadeIn 0.5s ease-out;
    }
    .animate-slide-up {
        animation: slideUp 0.5s ease-out;
    }
    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    @@keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    .rounded-lg {
        border-radius: 12px !important;
    }
</style>


@code {
    private BranchDto? sucursalSeleccionada;
    private IEnumerable<BranchDto> sucursales = new List<BranchDto>();
    private DateTime? fechaSeleccionada = DateTime.Today;
    private bool generando = false;
    private bool guardando = false;
    private bool reporteGenerado = false;

    private List<ReportRowDto>? datosReporte;
    private decimal totalSistema = 0;
    private decimal? totalCorteManual;

    private string notasReporte = "";

    // Variables para mantener el estado del reporte generado
    private BranchDto? sucursalReporte;
    private DateTime? fechaReporte;


    protected override async Task OnInitializedAsync()
    {
        try
        {
            sucursales = await BranchService.GetAllAsync();
            if (sucursales.Any())
            {
                sucursalSeleccionada = sucursales.FirstOrDefault(s => s.Name == "Himno") ?? sucursales.First();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Error al cargar sucursales", Severity.Error);
        }
    }

    private async Task GenerarReporte()
    {
        if (sucursalSeleccionada == null || fechaSeleccionada == null)
        {
            Snackbar.Add("Debe seleccionar una sucursal y una fecha", Severity.Warning);
            return;
        }

        // Validación previa
        var validacion = await ValidarAntesDeGenerar();
        if (!validacion.esValido)
        {
            Snackbar.Add(validacion.mensaje, Severity.Warning);
            return;
        }

        generando = true;
        reporteGenerado = false;
        datosReporte = null;
        totalCorteManual = null;
        notasReporte = "";

        var sucursalParaReporte = sucursalSeleccionada;
        var fechaParaReporte = fechaSeleccionada;

        try
        {
            datosReporte = await ReportGeneratorService.GenerarReportDataAsync(sucursalParaReporte!, fechaParaReporte.Value);

            // Actualizar variables del reporte generado
            sucursalReporte = sucursalParaReporte;
            fechaReporte = fechaParaReporte;

            if (datosReporte != null && datosReporte.Any())
            {
                totalSistema = datosReporte.Sum(x => x.Total);
                reporteGenerado = true;
                Snackbar.Add($"Reporte generado exitosamente. {datosReporte.Count} registros encontrados.", Severity.Success);
            }
            else
            {
                reporteGenerado = true;
                totalSistema = 0;
                Snackbar.Add("No se encontraron datos para los parámetros seleccionados", Severity.Info);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al generar reporte: {ex.Message}", Severity.Error);
            reporteGenerado = false;
        }
        finally
        {
            generando = false;
        }
    }

    private async Task<(bool esValido, string mensaje)> ValidarAntesDeGenerar()
    {
        // Verificar conexión con archivos
        var conexionValida = await DiagnosticService.VerifyConnectionAsync();
        if (!conexionValida)
        {
            return (false, "No se puede conectar a los archivos DBF. Verifique la configuración.");
        }

        // Validar que la fecha no sea futura
        if (fechaSeleccionada > DateTime.Today)
        {
            return (false, "No puede generar reportes para fechas futuras.");
        }

        return (true, "");
    }

    private void CalcularDiferencia()
    {
        // El cálculo se hace automáticamente en el render
        StateHasChanged();
    }

    private async Task GuardarEnHistorico()
    {
        if (datosReporte == null || !datosReporte.Any() || sucursalReporte == null || fechaReporte == null)
        {
            Snackbar.Add("No hay datos para guardar", Severity.Warning);
            return;
        }

        // Mostrar diálogo de confirmación
        var parameters = new DialogParameters
        {
            { "Sucursal", sucursalReporte?.Name },
            { "Fecha", fechaReporte?.ToString("dd/MM/yyyy") },
            { "TotalSistema", totalSistema },
            { "TotalManual", totalCorteManual },
            { "Diferencia", totalCorteManual.HasValue ? totalCorteManual.Value - totalSistema : (decimal?)null },
            { "Notas", notasReporte },
            { "NumeroRegistros", datosReporte.Count }
        };

        var dialog = await DialogService.ShowAsync<DialogoConfirmarGuardado>("Confirmar Guardado", parameters);
        var result = await dialog.Result;

        if (result.Canceled)
            return;

        guardando = true;

        try
        {
            var sucursal = Sucursal.Create(sucursalReporte!.Code, sucursalReporte!.Name);
            var detalles = datosReporte.Select(d => DetalleReporte.Crear(
                d.Fecha, 
                d.Caja, 
                d.Facturado, 
                d.Devolucion, 
                d.VentaGlobal, 
                d.Total)).ToList();

            var reporte = ReporteHistorico.Crear(
                sucursal,
                fechaReporte!.Value,
                totalSistema,
                totalCorteManual ?? 0,
                detalles
            );

            if (!string.IsNullOrEmpty(notasReporte))
            {
                reporte.ActualizarNotas(notasReporte);
            }

            await ReporteService.GuardarReporteAsync(reporte);
            Snackbar.Add("Reporte guardado exitosamente en el histórico", Severity.Success);

            // Limpiar formulario
            reporteGenerado = false;
            datosReporte = null;
            totalCorteManual = null;
            notasReporte = "";
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al guardar el reporte: {ex.Message}", Severity.Error);
        }
        finally
        {
            guardando = false;
        }
    }

    private async Task ExportarExcel()
    {
        if (datosReporte == null || !datosReporte.Any() || sucursalReporte == null || fechaReporte == null)
        {
            Snackbar.Add("No hay datos para exportar", Severity.Warning);
            return;
        }

        try
        {
            var contenido = await ExportService.ExportToExcelAsync(datosReporte, "Reporte");
            var nombreArchivo = $"Reporte_{sucursalReporte?.Name}_{fechaReporte:yyyyMMdd}.xlsx";

            await DescargarArchivo(contenido, nombreArchivo, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");

            Snackbar.Add("Reporte exportado exitosamente a Excel", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al exportar a Excel: {ex.Message}", Severity.Error);
        }
    }

    private async Task ExportarPDF()
    {
        if (datosReporte == null || !datosReporte.Any() || sucursalReporte == null || fechaReporte == null)
        {
            Snackbar.Add("No hay datos para exportar", Severity.Warning);
            return;
        }

        try
        {
            var contenido = await ExportService.ExportToPdfAsync(datosReporte, $"Reporte - {sucursalReporte?.Name}");
            var nombreArchivo = $"Reporte_{sucursalReporte?.Name}_{fechaReporte:yyyyMMdd}.pdf";

            await DescargarArchivo(contenido, nombreArchivo, "application/pdf");

            Snackbar.Add("Reporte exportado exitosamente a PDF", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al exportar a PDF: {ex.Message}", Severity.Error);
            Logger.LogError(ex, "Error al exportar a PDF");
        }
    }

    private async Task DescargarArchivo(byte[] contenido, string nombreArchivo, string contentType)
    {
        var base64 = Convert.ToBase64String(contenido);
        await JS.InvokeVoidAsync("fileDownloadHelper.downloadFile", nombreArchivo, contentType, base64);
    }
}