@page "/reimprimir"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@using Blanquita.Application.DTOs
@using Blanquita.Application.Interfaces
@using Blanquita.Domain.Enums
@using Microsoft.Extensions.Logging
@inject ICashCollectionService CashCollectionService
@inject ICashCutService CashCutService
@inject ICashRegisterService CashRegisterService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject ILogger<Reimpresiones> Logger
@using Blanquita.Web.Components.Layout

<PageTitle>Reimpresión Cortes/Recos - Sistema de Reportes</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4 animated fadeIn">
    <MudText Typo="Typo.h4" Class="mb-6 font-weight-bold" Style="background: linear-gradient(45deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
        <MudIcon Icon="@Icons.Material.Filled.Print" Class="mr-2" Size="Size.Large" Color="Color.Primary" />
        Reimpresión de Documentos
    </MudText>

    <MudCard Elevation="2" Class="mb-4 rounded-lg">
        <MudCardContent Class="pa-4">
            <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center">
                <MudToggleGroup T="TipoReporte" 
                               Color="Color.Primary" 
                               SelectionMode="SelectionMode.SingleSelection" 
                               @bind-Value="@accion" 
                               CheckMark 
                               FixedContent
                               Size="Size.Large">
                    <MudToggleItem Value="@TipoReporte.Recolecciones">
                        <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Size="Size.Small" Style="margin-right: 8px;" />
                        Recolecciones
                    </MudToggleItem>
                    <MudToggleItem Value="@TipoReporte.Cortes">
                        <MudIcon Icon="@Icons.Material.Filled.ContentCut" Size="Size.Small" Style="margin-right: 8px;" />
                        Cortes
                    </MudToggleItem>
                </MudToggleGroup>
            </MudStack>
        </MudCardContent>
    </MudCard>

    @if (accion == TipoReporte.Recolecciones)
    {
        <MudCard Elevation="4" Class="rounded-lg animate-slide-up">
            <MudTable ServerData="ServerReload" 
                      Hover="true" 
                      Dense="true"
                      @ref="recosTable"
                      Elevation="0"
                      Striped="true">
                <ToolBarContent>
                    <MudText Typo="Typo.h6" Color="Color.Success">
                        <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Class="mr-2" />
                        Recolecciones de Efectivo
                    </MudText>
                    <MudSpacer />
                    <MudTextField T="string" 
                                 ValueChanged="@(s=>OnSearch(s))" 
                                 Placeholder="Buscar por caja o folio..." 
                                 Adornment="Adornment.Start"
                                 AdornmentIcon="@Icons.Material.Filled.Search" 
                                 IconSize="Size.Medium" 
                                 Variant="Variant.Outlined"
                                 Margin="Margin.Dense"
                                 Class="mr-2"></MudTextField>
                </ToolBarContent>
                <HeaderContent>
                    <MudTh><MudTableSortLabel SortLabel="Id" T="CashCollectionDto">ID</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortLabel="Folio" T="CashCollectionDto">Folio</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortLabel="CollectionDateTime" T="CashCollectionDto">Fecha y Hora</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortLabel="CashRegisterName" T="CashCollectionDto">Caja Registradora</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortLabel="TotalAmount" T="CashCollectionDto">Cantidad Total</MudTableSortLabel></MudTh>
                    <MudTh Style="text-align: center;">Acciones</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Id">
                        <MudChip T="string" Color="Color.Info" Size="Size.Small">@context.Id</MudChip>
                    </MudTd>
                    <MudTd DataLabel="Folio">
                        <MudChip T="string" Color="Color.Warning" Size="Size.Small">@context.Folio</MudChip>
                    </MudTd>
                    <MudTd DataLabel="Fecha_Hora">
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Class="mr-2" />
                            <MudText Typo="Typo.body2">@context.CollectionDateTime.ToString("dd/MM/yyyy HH:mm")</MudText>
                        </div>
                    </MudTd>
                    <MudTd DataLabel="Caja">
                        <MudText Typo="Typo.body2" Class="font-weight-bold">@context.CashRegisterName</MudText>
                    </MudTd>
                    <MudTd DataLabel="Cantidad">
                        <MudChip T="string" Color="Color.Success" Size="Size.Small">@context.TotalAmount.ToString("C2")</MudChip>
                    </MudTd>
                    <MudTd Style="text-align: center;">
                        <MudTooltip Text="Ver detalles completos">
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                      Color="Color.Info" 
                                      Size="Size.Small"
                                      OnClick="@(() => VerDetalleRecoleccion(context))">
                            </MudIconButton>
                        </MudTooltip>
                        <MudTooltip Text="Reimprimir documento">
                            <MudIconButton Icon="@Icons.Material.Filled.Print" 
                                      Color="Color.Primary" 
                                      Size="Size.Small"
                                      OnClick="@(() => ImprimirRecoleccion(context.Id))">
                            </MudIconButton>
                        </MudTooltip>
                    </MudTd>
                </RowTemplate>
                <NoRecordsContent>
                    <MudPaper Elevation="0" Class="pa-12 d-flex flex-column align-center justify-center bg-transparent">
                        <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Default" Style="font-size: 4rem; opacity: 0.2;" />
                        <MudText Typo="Typo.h6" Class="mt-4 text-muted">No se encontraron recolecciones</MudText>
                        <MudText Typo="Typo.body2" Class="text-muted">Intenta ajustar los filtros de búsqueda</MudText>
                    </MudPaper>
                </NoRecordsContent>
                <LoadingContent>
                    <MudPaper Elevation="0" Class="pa-12 d-flex flex-column align-center justify-center bg-transparent">
                        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
                        <MudText Typo="Typo.body1" Class="mt-4">Cargando recolecciones...</MudText>
                    </MudPaper>
                </LoadingContent>
                <PagerContent>
                    <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
                </PagerContent>
            </MudTable>
        </MudCard>
    }
    else
    {
        <MudCard Elevation="4" Class="rounded-lg animate-slide-up">
            <MudTable ServerData="CargarDatosCortes" 
                      Hover="true" 
                      Dense="true"
                      @ref="cortesTable"
                      Elevation="0"
                      Striped="true">
                <ToolBarContent>
                    <MudText Typo="Typo.h6" Color="Color.Error">
                        <MudIcon Icon="@Icons.Material.Filled.ContentCut" Class="mr-2" />
                        Cortes de Caja
                    </MudText>
                    <MudSpacer />
                    <MudTextField T="string" 
                                 ValueChanged="@(s=>OnSearch(s))" 
                                 Placeholder="Buscar por caja..." 
                                 Adornment="Adornment.Start"
                                 AdornmentIcon="@Icons.Material.Filled.Search" 
                                 IconSize="Size.Medium" 
                                 Variant="Variant.Outlined"
                                 Margin="Margin.Dense"
                                 Class="mr-2"></MudTextField>
                </ToolBarContent>
                <HeaderContent>
                    <MudTh><MudTableSortLabel SortLabel="Id" T="CashCutDto">ID</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortLabel="CashRegisterName" T="CashCutDto">Caja</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortLabel="CashierName" T="CashCutDto">Cajera</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortLabel="SupervisorName" T="CashCutDto">Encargada</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortLabel="BranchName" T="CashCutDto">Sucursal</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortLabel="CutDateTime" T="CashCutDto">Fecha y Hora</MudTableSortLabel></MudTh>
                    <MudTh Style="text-align: center;">Acciones</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Id">
                        <MudChip T="string" Color="Color.Info" Size="Size.Small">@context.Id</MudChip>
                    </MudTd>
                    <MudTd DataLabel="Caja">
                        <MudText Typo="Typo.body2" Class="font-weight-bold">@context.CashRegisterName</MudText>
                    </MudTd>
                    <MudTd DataLabel="Cajera">
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Class="mr-2" />
                            <MudText Typo="Typo.body2">@context.CashierName</MudText>
                        </div>
                    </MudTd>
                    <MudTd DataLabel="Encargada">
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.SupervisorAccount" Size="Size.Small" Class="mr-2" />
                            <MudText Typo="Typo.body2">@context.SupervisorName</MudText>
                        </div>
                    </MudTd>
                    <MudTd DataLabel="Sucursal">
                        <MudChip T="string" Color="Color.Default" Size="Size.Small" Variant="Variant.Outlined">@context.BranchName</MudChip>
                    </MudTd>
                    <MudTd DataLabel="Fecha_Hora">
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Class="mr-2" />
                            <MudText Typo="Typo.body2">@context.CutDateTime.ToString("dd/MM/yyyy HH:mm")</MudText>
                        </div>
                    </MudTd>
                    <MudTd Style="text-align: center;">
                        <MudTooltip Text="Ver detalles completos">
                            <MudButton Variant="Variant.Filled"
                                      StartIcon="@Icons.Material.Filled.Visibility" 
                                      Color="Color.Info" 
                                      Size="Size.Small"
                                      OnClick="@(() => VerDetalleCorte(context))">
                                Detalles
                            </MudButton>
                        </MudTooltip>
                        <MudTooltip Text="Reimprimir documento">
                            <MudButton Variant="Variant.Filled"
                                      StartIcon="@Icons.Material.Filled.Print" 
                                      Color="Color.Primary" 
                                      Size="Size.Small"
                                      Class="ml-2"
                                      OnClick="@(() => ImprimirCorte(context.Id))">
                                Imprimir
                            </MudButton>
                        </MudTooltip>
                    </MudTd>
                </RowTemplate>
                <NoRecordsContent>
                    <MudPaper Elevation="0" Class="pa-12 d-flex flex-column align-center justify-center bg-transparent">
                        <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Default" Style="font-size: 4rem; opacity: 0.2;" />
                        <MudText Typo="Typo.h6" Class="mt-4 text-muted">No se encontraron cortes</MudText>
                        <MudText Typo="Typo.body2" Class="text-muted">Intenta ajustar los filtros de búsqueda</MudText>
                    </MudPaper>
                </NoRecordsContent>
                <LoadingContent>
                    <MudPaper Elevation="0" Class="pa-12 d-flex flex-column align-center justify-center bg-transparent">
                        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
                        <MudText Typo="Typo.body1" Class="mt-4">Cargando cortes...</MudText>
                    </MudPaper>
                </LoadingContent>
                <PagerContent>
                    <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
                </PagerContent>
            </MudTable>
        </MudCard>
    }
</MudContainer>

<style>
    .animate-fade-in {
        animation: fadeIn 0.5s ease-out;
    }
    .animate-slide-up {
        animation: slideUp 0.5s ease-out;
    }
    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    @@keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    .rounded-lg {
        border-radius: 12px !important;
    }
</style>

@code {
    private TipoReporte accion = TipoReporte.Recolecciones;
    private MudTable<CashCollectionDto> recosTable = null!;
    private MudTable<CashCutDto> cortesTable = null!;
    private string? searchString = null;

    private async Task<TableData<CashCollectionDto>> ServerReload(TableState state, CancellationToken token)
    {
        try
        {
            Logger.LogInformation("Cargando recolecciones con paginación. Página: {Page}, Tamaño: {PageSize}", 
                state.Page, state.PageSize);
                
            var data = await CashCollectionService.GetAllAsync(token);
            
            // Filter
            if (!string.IsNullOrWhiteSpace(searchString))
            {
                data = data.Where(d => 
                    d.CashRegisterName.Contains(searchString, StringComparison.OrdinalIgnoreCase) || 
                    d.Folio.ToString().Contains(searchString));
            }
            
            // Sort
            var items = data.OrderByDescending(x => x.Id).ToList();

            // Paging
            var paged = items.Skip(state.Page * state.PageSize).Take(state.PageSize).ToArray();
            
            Logger.LogInformation("Se cargaron {Count} de {Total} recolecciones", paged.Length, items.Count);
            
            return new TableData<CashCollectionDto> { TotalItems = items.Count, Items = paged };
        }
        catch (OperationCanceledException)
        {
            Logger.LogWarning("Carga de recolecciones cancelada");
            return new TableData<CashCollectionDto> { TotalItems = 0, Items = Array.Empty<CashCollectionDto>() };
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar recolecciones");
            Snackbar.Add("Error al cargar recolecciones", Severity.Error);
            return new TableData<CashCollectionDto> { TotalItems = 0, Items = Array.Empty<CashCollectionDto>() };
        }
    }

    private async Task<TableData<CashCutDto>> CargarDatosCortes(TableState state, CancellationToken token)
    {
        try
        {
            Logger.LogInformation("Cargando cortes con paginación. Página: {Page}, Tamaño: {PageSize}", 
                state.Page, state.PageSize);
                
            var data = await CashCutService.GetAllAsync(token);
            
            if (!string.IsNullOrWhiteSpace(searchString))
            {
                data = data.Where(d => d.CashRegisterName.Contains(searchString, StringComparison.OrdinalIgnoreCase));
            }
            
            var items = data.OrderByDescending(x => x.Id).ToList();
            var paged = items.Skip(state.Page * state.PageSize).Take(state.PageSize).ToArray();

            Logger.LogInformation("Se cargaron {Count} de {Total} cortes", paged.Length, items.Count);
            
            return new TableData<CashCutDto> { TotalItems = items.Count, Items = paged };
        }
        catch (OperationCanceledException)
        {
            Logger.LogWarning("Carga de cortes cancelada");
            return new TableData<CashCutDto> { TotalItems = 0, Items = Array.Empty<CashCutDto>() };
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar cortes");
            Snackbar.Add("Error al cargar cortes", Severity.Error);
            return new TableData<CashCutDto> { TotalItems = 0, Items = Array.Empty<CashCutDto>() };
        }
    }

    private void OnSearch(string text)
    {
        searchString = text;
        Logger.LogInformation("Búsqueda actualizada: {SearchString}", searchString);
        
        if (accion == TipoReporte.Recolecciones)
        {
            recosTable?.ReloadServerData();
        }
        else
        {
            cortesTable?.ReloadServerData();
        }
    }

    private Task ImprimirRecoleccion(int id)
    {
        Logger.LogInformation("Iniciando impresión de recolección con ID: {Id}", id);
        return MostrarDialogoImpresion(id, "Reco");
    }

    private Task ImprimirCorte(int id)
    {
        Logger.LogInformation("Iniciando impresión de corte con ID: {Id}", id);
        return MostrarDialogoImpresion(id, "Corte");
    }

    private async Task MostrarDialogoImpresion(int id, string tipo)
    {
        try
        {
            Logger.LogInformation("=== INICIO MostrarDialogoImpresion ===");
            Logger.LogInformation("ID: {Id}, Tipo: {Tipo}", id, tipo);
            
            // Obtener el BranchId según el tipo de documento
            int? branchId = null;
            
            if (tipo == "Reco")
            {
                Logger.LogInformation("Obteniendo recolección con ID: {Id}", id);
                var collection = await CashCollectionService.GetByIdAsync(id);
                
                if (collection != null)
                {
                    Logger.LogInformation("Recolección encontrada. CashRegisterName: '{CashRegisterName}'", collection.CashRegisterName);
                    
                    // Buscar la caja registradora por nombre para obtener el BranchId
                    var cashRegister = await CashRegisterService.GetByNameAsync(collection.CashRegisterName);
                    
                    if (cashRegister != null)
                    {
                        branchId = cashRegister.BranchId;
                        Logger.LogInformation("Caja registradora encontrada: {Name}, BranchId: {BranchId}", 
                            cashRegister.Name, branchId);
                    }
                    else
                    {
                        Logger.LogWarning("No se encontró la caja registradora con nombre: '{CashRegisterName}'", 
                            collection.CashRegisterName);
                    }
                }
                else
                {
                    Logger.LogWarning("No se encontró la recolección con ID: {Id}", id);
                }
            }
            else if (tipo == "Corte")
            {
                Logger.LogInformation("Obteniendo corte con ID: {Id}", id);
                var cut = await CashCutService.GetByIdAsync(id);
                
                if (cut != null)
                {
                    Logger.LogInformation("Corte encontrado. CashRegisterName: '{CashRegisterName}'", cut.CashRegisterName);
                    
                    // Buscar la caja registradora por nombre para obtener el BranchId
                    var cashRegister = await CashRegisterService.GetByNameAsync(cut.CashRegisterName);
                    
                    if (cashRegister != null)
                    {
                        branchId = cashRegister.BranchId;
                        Logger.LogInformation("Caja registradora encontrada: {Name}, BranchId: {BranchId}", 
                            cashRegister.Name, branchId);
                    }
                    else
                    {
                        Logger.LogWarning("No se encontró la caja registradora con nombre: '{CashRegisterName}'", 
                            cut.CashRegisterName);
                    }
                }
                else
                {
                    Logger.LogWarning("No se encontró el corte con ID: {Id}", id);
                }
            }
            
            Logger.LogInformation("BranchId final para pasar al diálogo: {BranchId}", branchId);
            
            var parameters = new DialogParameters<PrintDialog>
            {
                { x => x.idReco, id },
                { x => x.accion, tipo },
                { x => x.BranchId, branchId }
            };
            
            Logger.LogInformation("Abriendo diálogo con parámetros: idReco={Id}, accion={Tipo}, BranchId={BranchId}", 
                id, tipo, branchId);
            
            var options = new DialogOptions { CloseButton = true };
            await DialogService.ShowAsync<PrintDialog>("Seleccione Impresora", parameters, options);
            
            Logger.LogInformation("=== FIN MostrarDialogoImpresion ===");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al abrir el diálogo de impresión para {Tipo} con ID: {Id}", tipo, id);
            Snackbar.Add($"Error al abrir el diálogo de impresión: {ex.Message}", Severity.Error);
        }
    }

    private void VerDetalleRecoleccion(CashCollectionDto item)
    {
        var parameters = new DialogParameters { ["Recoleccion"] = item };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };
        DialogService.ShowAsync<DialogoDetalleRecoleccion>("Detalle de Recolección", parameters, options);
    }

    private void VerDetalleCorte(CashCutDto item)
    {
        var parameters = new DialogParameters { ["Corte"] = item };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };
        DialogService.ShowAsync<DialogoDetalleCorte>("Detalle de Corte", parameters, options);
    }
}
