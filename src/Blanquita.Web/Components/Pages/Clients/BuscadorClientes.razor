@page "/clientes"
@using Blanquita.Application.DTOs
@using Blanquita.Application.Interfaces.Repositories
@using Blanquita.Web.Components.Shared
@inject IClientCatalogRepository ClientRepository
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Buscador de Clientes</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4 animate-fade-in">
    <MudText Typo="Typo.h4" Class="mb-6 font-weight-bold" Style="background: linear-gradient(45deg, #1e88e5, #5e35b1); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
        <MudIcon Icon="@Icons.Material.Filled.PersonSearch" Class="mr-2" Size="Size.Large" Color="Color.Primary" />
        Buscador de Clientes
    </MudText>

    <MudGrid>
        <MudItem xs="12">
            <MudCard Elevation="4" Class="pa-4 rounded-lg">
                <MudCardContent>
                    <div class="d-flex gap-4 align-center">
                        <MudTextField @bind-Value="searchTerm"
                                      Label="Buscar Cliente (Nombre, RFC o Código)"
                                      Variant="Variant.Outlined"
                                      Adornment="Adornment.End"
                                      AdornmentIcon="@Icons.Material.Filled.Search"
                                      OnAdornmentClick="BuscarClientes"
                                      OnKeyUp="@(async (e) => { if (e.Key == "Enter") await BuscarClientes(); })"
                                      Immediate="true"
                                      FullWidth="true" />

                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   OnClick="BuscarClientes"
                                   Disabled="@isLoading"
                                   Height="56px"
                                   Class="px-8">
                            @if (isLoading)
                            {
                                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                <MudText Class="ms-2">Buscando...</MudText>
                            }
                            else
                            {
                                <MudText>Buscar</MudText>
                            }
                        </MudButton>
                    </div>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12">
            @if (clientes.Any())
            {
                <MudTable Items="@clientes" Hover="true" Breakpoint="Breakpoint.Sm" Elevation="4" Class="rounded-lg animate-slide-up">
                    <HeaderContent>
                        <MudTh>Código</MudTh>
                        <MudTh>Nombre</MudTh>
                        <MudTh>RFC</MudTh>
                        <MudTh>Teléfono</MudTh>
                        <MudTh>Acciones</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Código">
                            <MudChip T="string" Color="Color.Primary" Size="Size.Small" Variant="Variant.Text">@context.Code</MudChip>
                        </MudTd>
                        <MudTd DataLabel="Nombre">@context.Name</MudTd>
                        <MudTd DataLabel="RFC">@context.Rfc</MudTd>
                        <MudTd DataLabel="Teléfono">
                            @if (context.Addresses.Any(a => !string.IsNullOrEmpty(a.Phone)))
                            {
                                @context.Addresses.First(a => !string.IsNullOrEmpty(a.Phone)).Phone
                            }
                            else
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">--</MudText>
                            }
                        </MudTd>
                        <MudTd DataLabel="Acciones">
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Secondary"
                                       Size="Size.Small"
                                       StartIcon="@Icons.Material.Filled.Visibility"
                                       OnClick="@(() => VerDetalles(context))">
                                Ver Detalles
                            </MudButton>
                        </MudTd>
                    </RowTemplate>
                    <PagerContent>
                        <MudTablePager />
                    </PagerContent>
                </MudTable>
            }
            else if (hasSearched && !isLoading)
            {
                <MudAlert Severity="Severity.Info" Class="mt-4 rounded-lg">No se encontraron clientes con el término "@searchTerm". Asegúrese de que la configuración de rutas DBF sea correcta.</MudAlert>
            }
            else if (!hasSearched)
            {
                <MudCard Elevation="4" Class="rounded-lg pa-8 text-center animate-fade-in" Style="min-height: 400px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <MudCardContent>
                        <MudIcon Icon="@Icons.Material.Filled.PersonSearch" Size="Size.Large" Color="Color.Secondary" Style="font-size: 4rem; opacity: 0.3;" />
                        <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mt-4 font-weight-bold">
                            Inicie una búsqueda
                        </MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            Ingrese nombre, RFC o código para encontrar clientes
                        </MudText>
                    </MudCardContent>
                </MudCard>
            }
        </MudItem>
    </MudGrid>
</MudContainer>

<style>
    .animate-fade-in {
        animation: fadeIn 0.5s ease-out;
    }

    .animate-slide-up {
        animation: slideUp 0.5s ease-out;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @@keyframes slideUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .rounded-lg {
        border-radius: 12px !important;
    }
</style>

@code {
    private string searchTerm = string.Empty;
    private List<ClientSearchDto> clientes = new();
    private bool isLoading = false;
    private bool hasSearched = false;

    private async Task BuscarClientes()
    {
        if (string.IsNullOrWhiteSpace(searchTerm)) return;

        isLoading = true;
        hasSearched = false;
        clientes.Clear();

        try
        {
            var results = await ClientRepository.SearchAsync(searchTerm);
            clientes = results.ToList();
            hasSearched = true;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al buscar clientes: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void VerDetalles(ClientSearchDto cliente)
    {
        var parameters = new DialogParameters { ["Client"] = cliente };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        DialogService.Show<ClientDetailsDialog>($"Detalles del Cliente: {cliente.Name}", parameters, options);
    }
}
