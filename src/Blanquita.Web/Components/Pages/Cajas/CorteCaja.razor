@page "/corte-caja"
@using Blanquita.Application.DTOs
@using Blanquita.Application.Interfaces
@using System.Globalization
@inject ICashRegisterService CashRegisterService
@inject IPrintingService PrintingService
@inject ISnackbar Snackbar
@inject ISupervisorService SupervisorService
@inject ICashierService CashierService
@inject ICashCutService CashCutService
@inject ICashCollectionService CashCollectionService

<PageTitle>Corte de Caja</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4 animated fadeIn">
    <MudText Typo="Typo.h4" Class="mb-6 font-weight-bold" Style="background: linear-gradient(45deg, #d32f2f, #f44336); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
        <MudIcon Icon="@Icons.Material.Filled.PointOfSale" Class="mr-2" Size="Size.Large" Color="Color.Error" />
        Corte de Caja
    </MudText>

    @if (_isSubmitting)
    {
        <MudAlert Severity="Severity.Info" Class="mb-4 animate-fade-in" Elevation="2">
            <div class="d-flex align-center">
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-3" />
                <MudText Typo="Typo.body1">Procesando corte de caja...</MudText>
            </div>
        </MudAlert>
    }

    <EditForm Model="model" OnValidSubmit="HacerCorte">
        <MudGrid>
            <!-- Sección de Selección -->
            <MudItem xs="12" md="6">
                <MudCard Elevation="4" Class="pa-4 rounded-lg animate-slide-up">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6" Color="Color.Primary">
                                <MudIcon Icon="@Icons.Material.Filled.People" Class="mr-2" />
                                Información del Personal
                            </MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudSelect T="int" 
                                   Label="Seleccione encargada" 
                                   Value="_selectedSupervisorId" 
                                   ValueChanged="@(async (int value) => await OnSupervisorChanged(value))"
                                   Variant="Variant.Outlined"
                                   AnchorOrigin="Origin.BottomCenter"
                                   Class="mb-4"
                                   Adornment="Adornment.Start"
                                   AdornmentIcon="@Icons.Material.Filled.SupervisorAccount">
                            @if (supervisors == null)
                            {
                                <MudSelectItem T="int" Value="0">
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                    Cargando...
                                </MudSelectItem>
                            }
                            else
                            {
                                <MudSelectItem T="int" Value="0">-- Seleccione una encargada --</MudSelectItem>
                                @foreach (var supervisor in supervisors)
                                {
                                    <MudSelectItem T="int" Value="@supervisor.Id">@supervisor.Name</MudSelectItem>
                                }
                            }
                        </MudSelect>

                        <MudSelect T="int" 
                                   Label="Seleccione cajera" 
                                   @bind-Value="_selectedCashierId"
                                   Variant="Variant.Outlined"
                                   AnchorOrigin="Origin.BottomCenter"
                                   Class="mb-4"
                                   Disabled="@(_selectedSupervisorId == 0)"
                                   Adornment="Adornment.Start"
                                   AdornmentIcon="@Icons.Material.Filled.Person">
                            @if (cashiers == null || !cashiers.Any())
                            {
                                <MudSelectItem T="int" Value="0">-- Seleccione una encargada primero --</MudSelectItem>
                            }
                            else
                            {
                                <MudSelectItem T="int" Value="0">-- Seleccione una cajera --</MudSelectItem>
                                @foreach (var cashier in cashiers)
                                {
                                    if (cashier.IsActive)
                                    {
                                        <MudSelectItem T="int" Value="@cashier.Id">
                                            <div class="d-flex align-center">
                                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Color="Color.Success" Class="mr-2"/>
                                                @cashier.Name
                                            </div>
                                        </MudSelectItem>
                                    }
                                }
                            }
                        </MudSelect>

                        <MudSelect T="int" 
                                   Label="Seleccione caja" 
                                   Value="_selectedCashRegisterId"
                                   ValueChanged="@(async (int value) => await OnCashRegisterChanged(value))"
                                   Variant="Variant.Outlined"
                                   AnchorOrigin="Origin.BottomCenter"
                                   Disabled="@(_selectedSupervisorId == 0)"
                                   Adornment="Adornment.Start"
                                   AdornmentIcon="@Icons.Material.Filled.PointOfSale">
                            @if (cashRegisters == null || !cashRegisters.Any())
                            {
                                <MudSelectItem T="int" Value="0">-- Seleccione una encargada primero --</MudSelectItem>
                            }
                            else
                            {
                                <MudSelectItem T="int" Value="0">-- Seleccione una caja --</MudSelectItem>
                                @foreach (var register in cashRegisters)
                                {
                                    <MudSelectItem T="int" Value="@register.Id">
                                        <div class="d-flex align-center">
                                            <MudIcon Icon="@Icons.Material.Filled.Print" Size="Size.Small" Class="mr-2"/>
                                            @register.Name
                                        </div>
                                    </MudSelectItem>
                                }
                            }
                        </MudSelect>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Sección de Totales -->
            <MudItem xs="12" md="6">
                <MudCard Elevation="4" Class="pa-4 rounded-lg animate-slide-up" Style="animation-delay: 0.1s;">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6" Color="Color.Error">
                                <MudIcon Icon="@Icons.Material.Filled.Receipt" Class="mr-2" />
                                Totales del Corte
                            </MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudNumericField @bind-Value="model.TotalSlips" 
                                       Label="Total de Tira (Efectivo)" 
                                       Variant="Variant.Outlined" 
                                       Min="0"
                                       Class="mb-4"
                                       Adornment="Adornment.Start"
                                       AdornmentIcon="@Icons.Material.Filled.Receipt"
                                       AdornmentColor="Color.Info"
                                       Format="N2"
                                       Culture="@CultureInfo.InvariantCulture"
                                       HelperText="Total general mostrado en la tira de la caja registradora" />

                        <MudNumericField @bind-Value="model.TotalCards" 
                                       Label="Total Cobrado con Tarjeta" 
                                       Variant="Variant.Outlined" 
                                       Min="0"
                                       Adornment="Adornment.Start"
                                       AdornmentIcon="@Icons.Material.Filled.CreditCard"
                                       AdornmentColor="Color.Warning"
                                       Format="N2"
                                       Culture="@CultureInfo.InvariantCulture"
                                       HelperText="Ingrese el total de pagos con tarjeta del día" />

                        <MudDivider Class="my-4" />

                        <div class="d-flex justify-center flex-column align-center">
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">Efectivo a Entregar</MudText>
                            <MudPaper Elevation="3" Class="pa-4 rounded-lg" Style="background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%);">
                                <MudText Typo="Typo.h4" Class="font-weight-bold" Style="color: white;">
                                    $ @CalculateCashToDeliver().ToString("N2", CultureInfo.InvariantCulture)
                                </MudText>
                            </MudPaper>
                        </div>
                    </MudCardContent>
                    <MudCardActions Class="d-flex justify-center pa-4">
                        <MudButton ButtonType="ButtonType.Submit"
                                   Variant="Variant.Filled"
                                   Color="Color.Error"
                                   Disabled="@_isSubmitting"
                                   Size="Size.Large"
                                   StartIcon="@Icons.Material.Filled.ContentCut"
                                   FullWidth="true"
                                   Class="py-3 elevation-4">
                            @if (_isSubmitting)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                <text>Procesando...</text>
                            }
                            else
                            {
                                <text>Realizar Corte de Caja</text>
                            }
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        </MudGrid>
    </EditForm>
</MudContainer>

<style>
    .animate-fade-in {
        animation: fadeIn 0.5s ease-out;
    }
    .animate-slide-up {
        animation: slideUp 0.5s ease-out;
    }
    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    @@keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    .rounded-lg {
        border-radius: 12px !important;
    }
</style>

@code {
    private CashCutViewModel model = new CashCutViewModel();
    private int _selectedCashRegisterId = 0;
    private List<CashRegisterDto>? cashRegisters;
    private int _selectedSupervisorId = 0;
    private int _selectedCashierId = 0;
    private List<SupervisorDto>? supervisors;
    private List<CashierDto>? cashiers;
    private SupervisorDto? _selectedSupervisor;
    private bool _isSubmitting = false;
    private decimal _totalCollections = 0;

    protected override async Task OnInitializedAsync()
    {
        supervisors = (await SupervisorService.GetAllAsync()).ToList();
        cashiers = new List<CashierDto>();
        cashRegisters = new List<CashRegisterDto>();
    }

    private async Task OnSupervisorChanged(int supervisorId)
    {
        _selectedSupervisorId = supervisorId;
        _selectedCashierId = 0; 
        _selectedCashRegisterId = 0;
        _totalCollections = 0;

        if (supervisorId > 0)
        {
            _selectedSupervisor = await SupervisorService.GetByIdAsync(supervisorId);
            
            // Usar GetByBranchAsync que aún existe en los servicios
            cashRegisters = (await CashRegisterService.GetByBranchAsync(_selectedSupervisor.BranchId)).ToList();
            cashiers = (await CashierService.GetByBranchAsync(_selectedSupervisor.BranchId)).ToList(); 
        }
        else
        {
            cashRegisters = new List<CashRegisterDto>();
            cashiers = new List<CashierDto>();
        }

        StateHasChanged();
    }

    private async Task OnCashRegisterChanged(int cashRegisterId)
    {
        _selectedCashRegisterId = cashRegisterId;
        _totalCollections = 0;

        if (cashRegisterId > 0 && cashRegisters != null)
        {
            var register = cashRegisters.FirstOrDefault(r => r.Id == cashRegisterId);
            if (register != null)
            {
                // Obtener recolecciones sin corte de esta caja
                await LoadCollectionsTotal(register.Name);
            }
        }

        StateHasChanged();
    }

    private async Task LoadCollectionsTotal(string cashRegisterName)
    {
        try
        {
            var today = DateTime.Today;
            var endOfDay = today.AddDays(1).AddTicks(-1);

            var searchRequest = new SearchCashCollectionRequest
            {
                FechaInicio = today,
                FechaFin = endOfDay,
                CashRegisterName = cashRegisterName,
                IsCut = false
            };

            var collections = await CashCollectionService.SearchAsync(searchRequest);
            
            // Calcular el total de las recolecciones (suma de denominaciones)
            _totalCollections = collections.Sum(c => 
                (c.Thousands * 1000m) + 
                (c.FiveHundreds * 500m) + 
                (c.TwoHundreds * 200m) + 
                (c.Hundreds * 100m) + 
                (c.Fifties * 50m) + 
                (c.Twenties * 20m));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar recolecciones: {ex.Message}", Severity.Warning);
            _totalCollections = 0;
        }
    }

    private async Task HacerCorte()
    {
        if (_isSubmitting) return;
        if (_selectedSupervisorId == 0 || _selectedCashierId == 0 || _selectedCashRegisterId == 0)
        {
            Snackbar.Add("❗ Debe seleccionar encargada, cajera y caja.", Severity.Warning);
            return;
        }
        _isSubmitting = true;
        try
        {
            // 1. Prepare Request
            var request = new ProcessCashCutRequest
            {
                SupervisorId = _selectedSupervisorId,
                CashierId = _selectedCashierId,
                CashRegisterId = _selectedCashRegisterId,
                TotalSlips = model.TotalSlips,
                TotalCards = model.TotalCards
            };

            // 2. Delegate Business Logic to Service
            var savedCut = await CashCutService.ProcessCashCutAsync(request);

            // 3. Print (Presentation/Side-effect)
            // We need printer info, so we fetch the register
            // Optimization: Could request printer info as part of the service result wrap, but redundant for DTO.
            var register = await CashRegisterService.GetByIdAsync(_selectedCashRegisterId);

            try
            {
                await PrintingService.PrintCashCutAsync(savedCut, register.PrinterIp, register.PrinterPort);
                Snackbar.Add("✅ Corte impreso correctamente", Severity.Success);
            }
            catch (Exception)
            {
                 Snackbar.Add("❌ Error al imprimir corte.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"❌ Error general al realizar el corte: {ex.Message}", Severity.Error);
        }
        finally
        {
            ResetForm();
            _isSubmitting = false;
        }
    }

    private void ResetForm()
    {
        _selectedSupervisorId = 0;
        _selectedCashierId = 0;
        _selectedCashRegisterId = 0;
        _totalCollections = 0;
        model = new CashCutViewModel();
    }

    /// <summary>
    /// Calcula el efectivo a entregar: Total Tira - Total Recolecciones - Total Tarjetas
    /// </summary>
    private decimal CalculateCashToDeliver()
    {
        return model.TotalSlips - _totalCollections - model.TotalCards;
    }

    public class CashCutViewModel
    {
        public decimal TotalSlips { get; set; }
        public decimal TotalCards { get; set; }
    }
}