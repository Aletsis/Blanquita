@page "/configuracion"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@using Blanquita.Application.DTOs
@using Blanquita.Application.Interfaces
@using Blanquita.Application.Helpers
@using Blanquita.Domain.Enums
@using Blanquita.Web.Models
@using Blanquita.Web.Components.Layout
@using Microsoft.AspNetCore.Components.Forms
@inject IConfiguracionService ConfigService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject ILogger<Configuracion> Logger
@inject IDialogService DialogService
@inject IPrinterService PrinterService
@inject ICashRegisterService CashRegisterService
@inject IBranchService BranchService

<PageTitle>Configuración - Sistema de Reportes</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4 animated fadeIn">
    <MudText Typo="Typo.h4" Class="mb-6 font-weight-bold" Style="background: linear-gradient(45deg, #1e88e5, #5e35b1); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
        <MudIcon Icon="@Icons.Material.Filled.Settings" Class="mr-2" Size="Size.Large" Color="Color.Primary" />
        Configuración del Sistema
    </MudText>

    <MudGrid>
        <MudItem xs="12">
            <MudCard Elevation="4" Class="rounded-lg animate-slide-up">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6" Color="Color.Primary">
                            <MudIcon Icon="@Icons.Material.Filled.Folder" Class="mr-2" />
                            Rutas de Archivos DBF
                        </MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudIconButton Icon="@(_dbfConfigExpanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" 
                                      Color="Color.Default" 
                                      OnClick="ExpandDbfConfig" />
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                        Configure las rutas de los archivos de base de datos FoxPro necesarios para generar los reportes.
                    </MudText>
                    <MudCollapse Expanded="_dbfConfigExpanded">
                        <MudGrid>
                            <MudItem xs="12" md="6" lg="3">
                                <MudCard Outlined="true" Class="pa-3">
                                    <MudText Typo="Typo.subtitle1" Class="mb-2 font-weight-bold">
                                        <MudIcon Icon="@Icons.Material.Filled.Description" Size="Size.Small" Class="mr-1" />
                                        POS10041.DBF
                                    </MudText>
                                    <MudTextField @bind-Value="_configuracion.Pos10041Path" 
                                                 Label="Ruta del archivo" 
                                                 Variant="Variant.Outlined" 
                                                 ReadOnly="true" 
                                                 Adornment="Adornment.End" 
                                                 AdornmentIcon="@Icons.Material.Filled.FolderOpen" 
                                                 OnAdornmentClick="() => AbrirDialogoArchivo(TipoArchivoDbf.Pos10041)" 
                                                 Class="mb-2"
                                                 Margin="Margin.Dense" />
                                    @if (!string.IsNullOrEmpty(_configuracion.Pos10041Path)) 
                                    { 
                                        <MudChip T="string" 
                                                Size="Size.Small" 
                                                Color="@(ValidarRuta(_configuracion.Pos10041Path) ? Color.Success : Color.Error)" 
                                                Icon="@(ValidarRuta(_configuracion.Pos10041Path) ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Error)">
                                            @(ValidarRuta(_configuracion.Pos10041Path) ? "Archivo encontrado" : "Archivo no encontrado")
                                        </MudChip> 
                                    }
                                </MudCard>
                            </MudItem>
                            <MudItem xs="12" md="6" lg="3">
                                <MudCard Outlined="true" Class="pa-3">
                                    <MudText Typo="Typo.subtitle1" Class="mb-2 font-weight-bold">
                                        <MudIcon Icon="@Icons.Material.Filled.Description" Size="Size.Small" Class="mr-1" />
                                        POS10042.DBF
                                    </MudText>
                                    <MudTextField @bind-Value="_configuracion.Pos10042Path" 
                                                 Label="Ruta del archivo" 
                                                 Variant="Variant.Outlined" 
                                                 ReadOnly="true" 
                                                 Adornment="Adornment.End" 
                                                 AdornmentIcon="@Icons.Material.Filled.FolderOpen" 
                                                 OnAdornmentClick="() => AbrirDialogoArchivo(TipoArchivoDbf.Pos10042)" 
                                                 Class="mb-2"
                                                 Margin="Margin.Dense" />
                                    @if (!string.IsNullOrEmpty(_configuracion.Pos10042Path)) 
                                    { 
                                        <MudChip T="string" 
                                                Size="Size.Small" 
                                                Color="@(ValidarRuta(_configuracion.Pos10042Path) ? Color.Success : Color.Error)" 
                                                Icon="@(ValidarRuta(_configuracion.Pos10042Path) ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Error)">
                                            @(ValidarRuta(_configuracion.Pos10042Path) ? "Archivo encontrado" : "Archivo no encontrado")
                                        </MudChip> 
                                    }
                                </MudCard>
                            </MudItem>
                            <MudItem xs="12" md="6" lg="3">
                                <MudCard Outlined="true" Class="pa-3">
                                    <MudText Typo="Typo.subtitle1" Class="mb-2 font-weight-bold">
                                        <MudIcon Icon="@Icons.Material.Filled.Description" Size="Size.Small" Class="mr-1" />
                                        MGW10008.DBF
                                    </MudText>
                                    <MudTextField @bind-Value="_configuracion.Mgw10008Path" 
                                                 Label="Ruta del archivo" 
                                                 Variant="Variant.Outlined" 
                                                 ReadOnly="true" 
                                                 Adornment="Adornment.End" 
                                                 AdornmentIcon="@Icons.Material.Filled.FolderOpen" 
                                                 OnAdornmentClick="() => AbrirDialogoArchivo(TipoArchivoDbf.Mgw10008)" 
                                                 Class="mb-2"
                                                 Margin="Margin.Dense" />
                                    @if (!string.IsNullOrEmpty(_configuracion.Mgw10008Path)) 
                                    { 
                                        <MudChip T="string" 
                                                Size="Size.Small" 
                                                Color="@(ValidarRuta(_configuracion.Mgw10008Path) ? Color.Success : Color.Error)" 
                                                Icon="@(ValidarRuta(_configuracion.Mgw10008Path) ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Error)">
                                            @(ValidarRuta(_configuracion.Mgw10008Path) ? "Archivo encontrado" : "Archivo no encontrado")
                                        </MudChip> 
                                    }
                                </MudCard>
                            </MudItem>
                            <MudItem xs="12" md="6" lg="3">
                                <MudCard Outlined="true" Class="pa-3">
                                    <MudText Typo="Typo.subtitle1" Class="mb-2 font-weight-bold">
                                        <MudIcon Icon="@Icons.Material.Filled.Description" Size="Size.Small" Class="mr-1" />
                                        MGW10005.DBF
                                    </MudText>
                                    <MudTextField @bind-Value="_configuracion.Mgw10005Path" 
                                                 Label="Ruta del archivo" 
                                                 Variant="Variant.Outlined" 
                                                 ReadOnly="true" 
                                                 Adornment="Adornment.End" 
                                                 AdornmentIcon="@Icons.Material.Filled.FolderOpen" 
                                                 OnAdornmentClick="() => AbrirDialogoArchivo(TipoArchivoDbf.Mgw10005)" 
                                                 Class="mb-2"
                                                 Margin="Margin.Dense" />
                                    @if (!string.IsNullOrEmpty(_configuracion.Mgw10005Path)) 
                                    { 
                                        <MudChip T="string" 
                                                Size="Size.Small" 
                                                Color="@(ValidarRuta(_configuracion.Mgw10005Path) ? Color.Success : Color.Error)" 
                                                Icon="@(ValidarRuta(_configuracion.Mgw10005Path) ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Error)">
                                            @(ValidarRuta(_configuracion.Mgw10005Path) ? "Archivo encontrado" : "Archivo no encontrado")
                                        </MudChip> 
                                    }
                                </MudCard>
                            </MudItem>
                        </MudGrid>
                        <MudDivider Class="my-4" />
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudButton Variant="Variant.Outlined" 
                                      StartIcon="@Icons.Material.Filled.BugReport" 
                                      Color="Color.Info" 
                                      OnClick="IrADiagnostico">
                                Verificar Conexión
                            </MudButton>
                            <MudStack Row="true" Spacing="2">
                                <MudButton Variant="Variant.Outlined" 
                                          StartIcon="@Icons.Material.Filled.Restore" 
                                          OnClick="LimpiarFormulario">
                                    Limpiar
                                </MudButton>
                                <MudButton Variant="Variant.Filled" 
                                          StartIcon="@Icons.Material.Filled.Save" 
                                          Color="Color.Primary" 
                                          OnClick="GuardarConfiguracion" 
                                          Disabled="@_guardando"
                                          Size="Size.Medium">
                                    @if (_guardando) 
                                    { 
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" /> 
                                        <text>Guardando...</text> 
                                    } 
                                    else 
                                    { 
                                        <text>Guardar Configuración</text> 
                                    }
                                </MudButton>
                            </MudStack>
                        </MudStack>
                    </MudCollapse>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12">
            <MudCard Elevation="4" Class="rounded-lg animate-slide-up" Style="animation-delay: 0.1s;">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6" Color="Color.Primary">
                            <MudIcon Icon="@Icons.Material.Filled.Print" Class="mr-2" />
                            Impresoras Zebra
                        </MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudIconButton Icon="@(_zebraConfigExpanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" 
                                      Color="Color.Default" 
                                      OnClick="ExpandZebraConfig" />
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                        Configure las impresoras Zebra para la impresión de etiquetas.
                    </MudText>
                    <MudCollapse Expanded="_zebraConfigExpanded">
                        <MudTable Items="@_printers" 
                                 Hover="true" 
                                 Breakpoint="Breakpoint.Sm" 
                                 Loading="@_loadingPrinters" 
                                 LoadingProgressColor="Color.Info" 
                                 Elevation="0"
                                 Striped="true">
                            <ToolBarContent>
                                <MudText Typo="Typo.h6">
                                    <MudIcon Icon="@Icons.Material.Filled.Print" Size="Size.Small" Class="mr-2" />
                                    Impresoras Registradas
                                </MudText>
                                <MudSpacer />
                                <MudButton Variant="Variant.Filled" 
                                          StartIcon="@Icons.Material.Filled.Add" 
                                          Color="Color.Primary" 
                                          OnClick="() => AbrirDialogoImpresora()">
                                    Nueva Impresora
                                </MudButton>
                            </ToolBarContent>
                            <HeaderContent>
                                <MudTh>Nombre</MudTh>
                                <MudTh>Dirección IP</MudTh>
                                <MudTh>Puerto</MudTh>
                                <MudTh>DPI</MudTh>
                                <MudTh Style="text-align: center;">Acciones</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Nombre">
                                    <div class="d-flex align-center">
                                        <MudIcon Icon="@Icons.Material.Filled.Print" Size="Size.Small" Class="mr-2" />
                                        <MudText Typo="Typo.body2" Class="font-weight-bold">@context.Name</MudText>
                                    </div>
                                </MudTd>
                                <MudTd DataLabel="IP">
                                    <MudChip T="string" Color="Color.Info" Size="Size.Small" Variant="Variant.Text">@context.IpAddress</MudChip>
                                </MudTd>
                                <MudTd DataLabel="Puerto">
                                    <MudText Typo="Typo.body2">@context.Port</MudText>
                                </MudTd>
                                <MudTd DataLabel="DPI">
                                    <MudText Typo="Typo.body2">@context.Dpi</MudText>
                                </MudTd>
                                <MudTd DataLabel="Acciones" Style="text-align: center;">
                                    <MudTooltip Text="Editar impresora">
                                        <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                                      Size="Size.Small" 
                                                      Color="Color.Primary" 
                                                      OnClick="() => AbrirDialogoImpresora(context)" />
                                    </MudTooltip>
                                    <MudTooltip Text="Eliminar impresora">
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                      Size="Size.Small" 
                                                      Color="Color.Error" 
                                                      OnClick="() => EliminarImpresora(context)" />
                                    </MudTooltip>
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudPaper Elevation="0" Class="pa-12 d-flex flex-column align-center justify-center bg-transparent">
                                    <MudIcon Icon="@Icons.Material.Filled.PrintDisabled" Size="Size.Large" Color="Color.Default" Style="font-size: 4rem; opacity: 0.2;" />
                                    <MudText Typo="Typo.h6" Class="mt-4 text-muted">No hay impresoras configuradas</MudText>
                                    <MudText Typo="Typo.body2" Class="text-muted">Agregue una nueva impresora para comenzar</MudText>
                                </MudPaper>
                            </NoRecordsContent>
                        </MudTable>
                    </MudCollapse>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12">
            <MudCard Elevation="4" Class="rounded-lg animate-slide-up" Style="animation-delay: 0.15s;">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6" Color="Color.Primary">
                            <MudIcon Icon="@Icons.Material.Filled.Store" Class="mr-2" />
                            Gestión de Sucursales
                        </MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudIconButton Icon="@(_sucursalesConfigExpanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" 
                                      Color="Color.Default" 
                                      OnClick="ExpandSucursalesConfig" />
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                        Gestione las sucursales y sus series de facturación.
                    </MudText>
                    <MudCollapse Expanded="_sucursalesConfigExpanded">
                        <MudTable Items="@sucursales" 
                                 Hover="true" 
                                 Breakpoint="Breakpoint.Sm" 
                                 Elevation="0"
                                 Striped="true">
                            <ToolBarContent>
                                <MudText Typo="Typo.h6">
                                    <MudIcon Icon="@Icons.Material.Filled.Store" Size="Size.Small" Class="mr-2" />
                                    Sucursales Registradas
                                </MudText>
                                <MudSpacer />
                                <MudButton Variant="Variant.Filled" 
                                          StartIcon="@Icons.Material.Filled.Add" 
                                          Color="Color.Primary" 
                                          OnClick="() => AbrirDialogoSucursal()">
                                    Nueva Sucursal
                                </MudButton>
                            </ToolBarContent>
                            <HeaderContent>
                                <MudTh>Nombre</MudTh>
                                <MudTh>Código</MudTh>
                                <MudTh>Serie Cliente</MudTh>
                                <MudTh>Serie Global</MudTh>
                                <MudTh>Serie Devolución</MudTh>
                                <MudTh Style="text-align: center;">Acciones</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Nombre">
                                    <div class="d-flex align-center">
                                        <MudIcon Icon="@Icons.Material.Filled.Store" Size="Size.Small" Class="mr-2" />
                                        <MudText Typo="Typo.body2" Class="font-weight-bold">@context.Name</MudText>
                                    </div>
                                </MudTd>
                                <MudTd DataLabel="Código">@context.Code</MudTd>
                                <MudTd DataLabel="Serie Cliente">@context.SeriesCliente</MudTd>
                                <MudTd DataLabel="Serie Global">@context.SeriesGlobal</MudTd>
                                <MudTd DataLabel="Serie Devolución">@context.SeriesDevolucion</MudTd>
                                <MudTd DataLabel="Acciones" Style="text-align: center;">
                                    <MudTooltip Text="Editar sucursal">
                                        <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                                      Size="Size.Small" 
                                                      Color="Color.Primary" 
                                                      OnClick="() => AbrirDialogoSucursal(context)" />
                                    </MudTooltip>
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudPaper Elevation="0" Class="pa-8 d-flex flex-column align-center justify-center bg-transparent">
                                    <MudText Typo="Typo.body2" Class="text-muted">No hay sucursales registradas</MudText>
                                </MudPaper>
                            </NoRecordsContent>
                        </MudTable>
                    </MudCollapse>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12">
            <MudCard Elevation="4" Class="rounded-lg animate-slide-up" Style="animation-delay: 0.2s;">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6" Color="Color.Primary">
                            <MudIcon Icon="@Icons.Material.Filled.PointOfSale" Class="mr-2" />
                            Gestión de Cajas
                        </MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudIconButton Icon="@(_cajasConfigExpanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" 
                                      Color="Color.Default" 
                                      OnClick="ExpandCajasConfig" />
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                        Configure las cajas registradoras del sistema.
                    </MudText>
                    <MudCollapse Expanded="_cajasConfigExpanded">
                        @if (_isInitialized)
                        {
                            <MudTable ServerData="ServerReload" 
                                 Dense="true" 
                                 Hover="true" 
                                 @ref="table"
                                 Striped="true"
                                 Elevation="0">
                            <ToolBarContent>
                                <MudText Typo="Typo.h6">
                                    <MudIcon Icon="@Icons.Material.Filled.List" Size="Size.Small" Class="mr-2" />
                                    Cajas Registradas
                                </MudText>
                                <MudSpacer />
                                <MudTextField T="string" 
                                             ValueChanged="@(s=>OnSearch(s))" 
                                             Placeholder="Buscar" 
                                             Adornment="Adornment.Start"
                                             AdornmentIcon="@Icons.Material.Filled.Search" 
                                             IconSize="Size.Medium" 
                                             Class="mt-0 mr-2"
                                             Margin="Margin.Dense" />
                                <MudButton Variant="Variant.Filled" 
                                          StartIcon="@Icons.Material.Filled.Add" 
                                          Color="Color.Primary" 
                                          OnClick="() => AbrirDialogoCaja()">
                                    Añadir Caja
                                </MudButton>
                            </ToolBarContent>
                            <HeaderContent>
                                <MudTh><MudTableSortLabel SortLabel="Id" T="CashRegisterDto">Id</MudTableSortLabel></MudTh>
                                <MudTh><MudTableSortLabel SortLabel="Name" T="CashRegisterDto">Nombre</MudTableSortLabel></MudTh>
                                <MudTh><MudTableSortLabel SortLabel="PrinterIp" T="CashRegisterDto">IP de impresora</MudTableSortLabel></MudTh>
                                <MudTh><MudTableSortLabel SortLabel="PrinterPort" T="CashRegisterDto">Puerto impresora</MudTableSortLabel></MudTh>
                                <MudTh><MudTableSortLabel SortLabel="BranchId" T="CashRegisterDto">Sucursal</MudTableSortLabel></MudTh>
                                <MudTh>Última</MudTh>
                                <MudTh Style="text-align: center;">Acciones</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Id">@context.Id</MudTd>
                                <MudTd DataLabel="Name">
                                    <div class="d-flex align-center">
                                        <MudIcon Icon="@Icons.Material.Filled.PointOfSale" Size="Size.Small" Class="mr-2" />
                                        <MudText Typo="Typo.body2" Class="font-weight-bold">@context.Name</MudText>
                                    </div>
                                </MudTd>
                                <MudTd DataLabel="PrinterIp">
                                    <MudChip T="string" Color="Color.Info" Size="Size.Small" Variant="Variant.Text">@context.PrinterIp</MudChip>
                                </MudTd>
                                <MudTd DataLabel="PrinterPort">@context.PrinterPort</MudTd>
                                <MudTd DataLabel="BranchId">@GetSucursalName(context.BranchId)</MudTd>
                                <MudTd DataLabel="Ultima">
                                    <MudChip T="string" 
                                            Color="@(context.IsLastRegister ? Color.Success : Color.Default)" 
                                            Size="Size.Small"
                                            Variant="Variant.Text">
                                        @(context.IsLastRegister ? "Sí" : "No")
                                    </MudChip>
                                </MudTd>
                                <MudTd DataLabel="Acciones" Style="text-align: center;">
                                    <MudTooltip Text="Editar caja">
                                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                      Size="Size.Small"
                                                      Color="Color.Primary"
                                                      OnClick="@(() => AbrirDialogoCaja(context))" />
                                    </MudTooltip>
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudPaper Elevation="0" Class="pa-12 d-flex flex-column align-center justify-center bg-transparent">
                                    <MudIcon Icon="@Icons.Material.Filled.PointOfSale" Size="Size.Large" Color="Color.Default" Style="font-size: 4rem; opacity: 0.2;" />
                                    <MudText Typo="Typo.h6" Class="mt-4 text-muted">No hay cajas configuradas</MudText>
                                    <MudText Typo="Typo.body2" Class="text-muted">Haga clic en "Añadir Caja" para comenzar</MudText>
                                </MudPaper>
                            </NoRecordsContent>
                            <LoadingContent>
                                <MudProgressCircular Indeterminate="true" />
                            </LoadingContent>
                            <PagerContent>
                                <MudTablePager />
                            </PagerContent>
                            </MudTable>
                        }
                        else
                        {
                            <MudPaper Elevation="0" Class="pa-12 d-flex flex-column align-center justify-center bg-transparent">
                                <MudProgressCircular Indeterminate="true" />
                                <MudText Typo="Typo.body2" Class="mt-4 text-muted">Cargando...</MudText>
                            </MudPaper>
                        }
                    </MudCollapse>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>

<style>
    .animate-fade-in {
        animation: fadeIn 0.5s ease-out;
    }
    .animate-slide-up {
        animation: slideUp 0.5s ease-out;
    }
    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    @@keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    .rounded-lg {
        border-radius: 12px !important;
    }
</style>

@code {
    private ConfiguracionDto _configuracion = new();
    private List<PrinterDto> _printers = new();
    private bool _guardando = false;
    private bool _loadingPrinters = false;
    private bool _zebraConfigExpanded = false;
    private bool _dbfConfigExpanded = false;

    private bool _cajasConfigExpanded = false;
    private bool _sucursalesConfigExpanded = false;
    private bool _isInitialized = false;

    // Variables para gestión de cajas
    private IEnumerable<BranchDto> sucursales = Enumerable.Empty<BranchDto>();
    private MudTable<CashRegisterDto>? table;
    private string searchString = "";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _configuracion = await ConfigService.ObtenerConfiguracionAsync();
            await RecargarImpresoras();
            sucursales = await BranchService.GetAllAsync();
            
            // Marcar como inicializado para permitir la carga de la tabla
            _isInitialized = true;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar la configuración inicial");
            Snackbar.Add("Error al cargar la configuración", Severity.Error);
            _isInitialized = true; // Permitir mostrar la UI incluso si hay error
        }
    }

    private void ExpandZebraConfig() => _zebraConfigExpanded = !_zebraConfigExpanded;
    private void ExpandDbfConfig() => _dbfConfigExpanded = !_dbfConfigExpanded;
    private void ExpandCajasConfig() => _cajasConfigExpanded = !_cajasConfigExpanded;
    private void ExpandSucursalesConfig() => _sucursalesConfigExpanded = !_sucursalesConfigExpanded;

    private async Task AbrirDialogoArchivo(TipoArchivoDbf tipoArchivo)
    {
        try
        {
            var nombreArchivo = ConfigService.ObtenerNombreArchivo(tipoArchivo);
            var rutaActual = _configuracion.ObtenerRutaPorTipo(tipoArchivo);

            var dialogOptions = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
            var parameters = new DialogParameters
            {
                { "ArchivoActual", rutaActual },
                { "NombreArchivo", nombreArchivo }
            };

            var dialog = await DialogService.ShowAsync<DialogoSeleccionArchivo>("Seleccionar Archivo", parameters, dialogOptions);
            var result = await dialog.Result;

            if (!result.Canceled && result.Data is string rutaSeleccionada)
            {
                _configuracion.EstablecerRutaPorTipo(tipoArchivo, rutaSeleccionada);
                Logger.LogInformation("Ruta actualizada para {TipoArchivo}: {Ruta}", tipoArchivo, rutaSeleccionada);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al seleccionar archivo para {TipoArchivo}", tipoArchivo);
            Snackbar.Add($"Error al seleccionar archivo: {ex.Message}", Severity.Error);
        }
    }

    private async Task GuardarConfiguracion()
    {
        _guardando = true;
        
        try
        {
            // Validar configuración
            var validacion = await ConfigService.ValidarConfiguracionAsync(_configuracion);
            
            if (!validacion.EsValido)
            {
                foreach (var error in validacion.Errores)
                {
                    Snackbar.Add(error, Severity.Warning);
                }
                return;
            }

            // Mostrar advertencias si las hay
            foreach (var advertencia in validacion.Advertencias)
            {
                Snackbar.Add(advertencia, Severity.Info);
            }

            // Guardar configuración
            await ConfigService.GuardarConfiguracionAsync(_configuracion);
            
            Logger.LogInformation("Configuración guardada exitosamente");
            Snackbar.Add("Configuración guardada exitosamente", Severity.Success);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al guardar la configuración");
            Snackbar.Add($"Error al guardar la configuración: {ex.Message}", Severity.Error);
        }
        finally
        {
            _guardando = false;
        }
    }

    private async Task LimpiarFormulario()
    {
        try
        {
            await ConfigService.RestablecerConfiguracionAsync();
            _configuracion = await ConfigService.ObtenerConfiguracionAsync();
            
            Logger.LogInformation("Formulario de configuración restablecido");
            Snackbar.Add("Configuración restablecida a valores predeterminados", Severity.Info);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al restablecer la configuración");
            Snackbar.Add($"Error al restablecer: {ex.Message}", Severity.Error);
        }
    }

    private async Task RecargarImpresoras()
    {
        _loadingPrinters = true;
        try
        {
            _printers = await PrinterService.GetAllAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar impresoras: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loadingPrinters = false;
        }
    }

    private async Task AbrirDialogoImpresora(PrinterDto? printer = null)
    {
        var parameters = new DialogParameters();
        if (printer != null)
        {
            parameters.Add("Model", new PrinterDto 
            { 
                Id = printer.Id, 
                Name = printer.Name, 
                IpAddress = printer.IpAddress, 
                Port = printer.Port,
                Dpi = printer.Dpi,
                IsActive = printer.IsActive
            });
        }

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var title = printer == null ? "Nueva Impresora" : "Editar Impresora";
        var dialog = await DialogService.ShowAsync<DialogoImpresora>(title, parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is PrinterDto printerResult)
        {
            try
            {
                if (printer == null)
                {
                    await PrinterService.CreateAsync(printerResult);
                    Snackbar.Add("Impresora agregada exitosamente", Severity.Success);
                }
                else
                {
                    await PrinterService.UpdateAsync(printerResult);
                    Snackbar.Add("Impresora actualizada exitosamente", Severity.Success);
                }
                await RecargarImpresoras();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error al guardar impresora: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task EliminarImpresora(PrinterDto printer)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Confirmar Eliminación",
            $"¿Está seguro que desea eliminar la impresora {printer.Name}?",
            yesText: "Eliminar", cancelText: "Cancelar"
        );

        if (result == true)
        {
            try
            {
                await PrinterService.DeleteAsync(printer.Id);
                Snackbar.Add("Impresora eliminada exitosamente", Severity.Success);
                await RecargarImpresoras();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error al eliminar impresora: {ex.Message}", Severity.Error);
            }
        }
    }

    private void IrADiagnostico()
    {
        Navigation.NavigateTo("/diagnostico");
    }

    // Métodos auxiliares para la vista
    private string ObtenerRutaPorTipo(TipoArchivoDbf tipo) => _configuracion.ObtenerRutaPorTipo(tipo);
    private void EstablecerRutaPorTipo(TipoArchivoDbf tipo, string ruta) => _configuracion.EstablecerRutaPorTipo(tipo, ruta);
    private bool ValidarRuta(string ruta) => ConfigService.ValidarRutaArchivo(ruta);



    // ===== Métodos para gestión de sucursales =====
    private async Task AbrirDialogoSucursal(BranchDto? sucursal = null)
    {
        var parameters = new DialogParameters();
        if (sucursal != null)
        {
            parameters.Add("Model", new BranchDto 
            { 
                Id = sucursal.Id, 
                Name = sucursal.Name,
                Code = sucursal.Code,
                SeriesCliente = sucursal.SeriesCliente,
                SeriesGlobal = sucursal.SeriesGlobal,
                SeriesDevolucion = sucursal.SeriesDevolucion
            });
        }

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var title = sucursal == null ? "Nueva Sucursal" : "Editar Sucursal";
        var dialog = await DialogService.ShowAsync<DialogoSucursal>(title, parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is BranchDto branchResult)
        {
            try
            {
                if (sucursal == null)
                {
                    await BranchService.CreateAsync(branchResult);
                    Snackbar.Add("Sucursal agregada exitosamente", Severity.Success);
                }
                else
                {
                    await BranchService.UpdateAsync(branchResult);
                    Snackbar.Add("Sucursal actualizada exitosamente", Severity.Success);
                }
                
                // Recargar lista
                sucursales = await BranchService.GetAllAsync();
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error al guardar sucursal");
                Snackbar.Add($"Error al guardar: {ex.Message}", Severity.Error);
            }
        }
    }

    // ===== Métodos para gestión de cajas =====
    
    private string GetSucursalName(int id) => sucursales.FirstOrDefault(s => s.Id == id)?.Name ?? id.ToString();

    private async Task AbrirDialogoCaja(CashRegisterDto? caja = null)
    {
        var parameters = new DialogParameters();
        if (caja != null)
        {
            parameters.Add("Model", new DialogoCaja.CashRegisterDialogModel
            {
                Id = caja.Id,
                Name = caja.Name,
                Serie = caja.Serie,
                PrinterIp = caja.PrinterIp,
                PrinterPort = caja.PrinterPort,
                BranchId = caja.BranchId,
                IsLastRegister = caja.IsLastRegister
            });
        }

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var title = caja == null ? "Nueva Caja" : "Editar Caja";
        var dialog = await DialogService.ShowAsync<DialogoCaja>(title, parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is DialogoCaja.CashRegisterDialogModel cajaResult)
        {
            try
            {
                if (caja == null)
                {
                    var createDto = new CreateCashRegisterDto
                    {
                        Name = cajaResult.Name,
                        Serie = cajaResult.Serie,
                        PrinterIp = cajaResult.PrinterIp,
                        PrinterPort = cajaResult.PrinterPort,
                        BranchId = cajaResult.BranchId,
                        IsLastRegister = cajaResult.IsLastRegister
                    };
                    await CashRegisterService.CreateAsync(createDto);
                    Snackbar.Add("Caja agregada exitosamente", Severity.Success);
                }
                else
                {
                    var updateDto = new UpdateCashRegisterDto
                    {
                        Id = cajaResult.Id,
                        Name = cajaResult.Name,
                        Serie = cajaResult.Serie,
                        PrinterIp = cajaResult.PrinterIp,
                        PrinterPort = cajaResult.PrinterPort,
                        BranchId = cajaResult.BranchId,
                        IsLastRegister = cajaResult.IsLastRegister
                    };
                    await CashRegisterService.UpdateAsync(updateDto);
                    Snackbar.Add("Caja actualizada exitosamente", Severity.Success);
                }
                await table!.ReloadServerData();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error al guardar la caja");
                Snackbar.Add($"Error al guardar: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task<TableData<CashRegisterDto>> ServerReload(TableState state, CancellationToken token)
    {
        try 
        {
            // Construir la solicitud de búsqueda paginada
            var request = new SearchCashRegisterRequest
            {
                SearchTerm = searchString,
                Page = state.Page + 1, // MudTable usa base 0, PagedSearchRequest usa base 1
                PageSize = state.PageSize,
                SortColumn = state.SortLabel ?? "Id",
                SortAscending = state.SortDirection != SortDirection.Descending
            };

            // Usar el servicio para obtener datos paginados
            var result = await CashRegisterService.GetPagedAsync(request, token);
            
            return new TableData<CashRegisterDto>() 
            { 
                TotalItems = result.TotalCount, 
                Items = result.Items.ToArray() 
            };
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading cash registers");
            return new TableData<CashRegisterDto>() { TotalItems = 0, Items = Array.Empty<CashRegisterDto>() };
        }
    }

    private void OnSearch(string text)
    {
        searchString = text;
        table?.ReloadServerData();
    }
}