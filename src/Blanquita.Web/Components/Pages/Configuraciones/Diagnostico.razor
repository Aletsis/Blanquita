@page "/diagnostico"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@using Blanquita.Web.Components.Layout
@using Blanquita.Application.Interfaces
@using Blanquita.Application.DTOs
@using Blanquita.Infrastructure.Models
@inject IConfiguracionService ConfigService
@inject IFoxProReportService FoxProService
@inject ISnackbar Snackbar

<PageTitle>Diagnóstico - Sistema de Reportes</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4 animated fadeIn">
    <MudText Typo="Typo.h4" Class="mb-6 font-weight-bold" Style="background: linear-gradient(45deg, #1e88e5, #5e35b1); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
        <MudIcon Icon="@Icons.Material.Filled.BugReport" Class="mr-2" Size="Size.Large" Color="Color.Primary" />
        Diagnóstico del Sistema
    </MudText>

    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-6">
        Ejecute pruebas de diagnóstico para verificar la configuración y conexión con los archivos DBF.
    </MudText>
    
    <!-- Botón de ejecutar todos -->
    <MudCard Elevation="4" Class="mb-6 rounded-lg animate-slide-up" Style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
        <MudCardContent>
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <div>
                     <MudText Typo="Typo.h6" Class="font-weight-bold" Color="Color.Primary">
                        Diagnóstico Completo
                    </MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Ejecutar todas las pruebas de conexión y estructura de archivos.
                    </MudText>
                </div>
               
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Speed"
                           OnClick="EjecutarTodos"
                           Disabled="@ejecutandoTodos"
                           Size="Size.Large"
                           Class="elevation-4">
                    @if (ejecutandoTodos)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <text>Procesando...</text>
                    }
                    else
                    {
                        <text>Ejecutar Todo</text>
                    }
                </MudButton>
            </MudStack>
        </MudCardContent>
    </MudCard>

    <MudGrid>
        <!-- Card para POS10041 -->
        <MudItem xs="12">
            <MudCard Elevation="3" Class="rounded-lg animate-slide-up" Style="animation-delay: 0.1s;">
                <MudCardHeader>
                     <CardHeaderAvatar>
                        <MudAvatar Color="Color.Tertiary" Variant="Variant.Filled">
                            <MudIcon Icon="@Icons.Material.Filled.TableView" />
                        </MudAvatar>
                    </CardHeaderAvatar>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">POS10041.DBF</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Configuración de Cajas</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                         <MudButton Variant="Variant.Outlined"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.PlayArrow"
                                   OnClick="() => EjecutarDiagnostico(1)"
                                   Disabled="@(ejecutando1 || string.IsNullOrEmpty(config.Pos10041Path))">
                            @if (ejecutando1)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                <text>Ejecutando...</text>
                            }
                            else
                            {
                                <text>Verificar</text>
                            }
                        </MudButton>
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    <MudText Typo="Typo.body2" Class="mb-2">
                         <MudIcon Icon="@Icons.Material.Filled.Folder" Size="Size.Small" Class="mr-1 vertical-align-middle" Color="Color.Default" />
                         <strong>Ruta:</strong> 
                        @if (!string.IsNullOrEmpty(config.Pos10041Path))
                        {
                            <span class="ml-1">@config.Pos10041Path</span>
                        }
                        else
                        {
                            <MudChip T="string" Color="Color.Warning" Size="Size.Small" Class="ml-2">No configurado</MudChip>
                        }
                    </MudText>

                    @if (resultado1 != null)
                    {
                        <div class="mt-4 animate-fade-in">
                            <ComponenteDiagnostico Resultado="@resultado1" />
                        </div>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Card para POS10042 -->
        <MudItem xs="12">
            <MudCard Elevation="3" Class="rounded-lg animate-slide-up" Style="animation-delay: 0.2s;">
                <MudCardHeader>
                     <CardHeaderAvatar>
                        <MudAvatar Color="Color.Info" Variant="Variant.Filled">
                            <MudIcon Icon="@Icons.Material.Filled.ReceiptLong" />
                        </MudAvatar>
                    </CardHeaderAvatar>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">POS10042.DBF</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Movimientos de Venta</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.PlayArrow"
                                   OnClick="() => EjecutarDiagnostico(2)"
                                   Disabled="@(ejecutando2 || string.IsNullOrEmpty(config.Pos10042Path))">
                            @if (ejecutando2)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                <text>Ejecutando...</text>
                            }
                            else
                            {
                                <text>Verificar</text>
                            }
                        </MudButton>
                    </CardHeaderActions>
                </MudCardHeader>
                 <MudCardContent>
                    <MudText Typo="Typo.body2" Class="mb-2">
                         <MudIcon Icon="@Icons.Material.Filled.Folder" Size="Size.Small" Class="mr-1 vertical-align-middle" Color="Color.Default" />
                         <strong>Ruta:</strong> 
                        @if (!string.IsNullOrEmpty(config.Pos10042Path))
                        {
                            <span class="ml-1">@config.Pos10042Path</span>
                        }
                        else
                        {
                            <MudChip T="string" Color="Color.Warning" Size="Size.Small" Class="ml-2">No configurado</MudChip>
                        }
                    </MudText>

                    @if (resultado2 != null)
                    {
                        <div class="mt-4 animate-fade-in">
                            <ComponenteDiagnostico Resultado="@resultado2" />
                        </div>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Card para MGW10008 -->
        <MudItem xs="12">
            <MudCard Elevation="3" Class="rounded-lg animate-slide-up" Style="animation-delay: 0.3s;">
                <MudCardHeader>
                    <CardHeaderAvatar>
                        <MudAvatar Color="Color.Warning" Variant="Variant.Filled">
                            <MudIcon Icon="@Icons.Material.Filled.Description" />
                        </MudAvatar>
                    </CardHeaderAvatar>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">MGW10008.DBF</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Documentos</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.PlayArrow"
                                   OnClick="() => EjecutarDiagnostico(3)"
                                   Disabled="@(ejecutando3 || string.IsNullOrEmpty(config.Mgw10008Path))">
                            @if (ejecutando3)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                <text>Ejecutando...</text>
                            }
                            else
                            {
                                <text>Verificar</text>
                            }
                        </MudButton>
                    </CardHeaderActions>
                </MudCardHeader>
                 <MudCardContent>
                    <MudText Typo="Typo.body2" Class="mb-2">
                         <MudIcon Icon="@Icons.Material.Filled.Folder" Size="Size.Small" Class="mr-1 vertical-align-middle" Color="Color.Default" />
                         <strong>Ruta:</strong> 
                        @if (!string.IsNullOrEmpty(config.Mgw10008Path))
                        {
                            <span class="ml-1">@config.Mgw10008Path</span>
                        }
                        else
                        {
                            <MudChip T="string" Color="Color.Warning" Size="Size.Small" Class="ml-2">No configurado</MudChip>
                        }
                    </MudText>

                    @if (resultado3 != null)
                    {
                        <div class="mt-4 animate-fade-in">
                            <ComponenteDiagnostico Resultado="@resultado3" />
                        </div>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Card para MGW10005 -->
        <MudItem xs="12">
            <MudCard Elevation="3" Class="rounded-lg animate-slide-up" Style="animation-delay: 0.4s;">
                <MudCardHeader>
                     <CardHeaderAvatar>
                        <MudAvatar Color="Color.Success" Variant="Variant.Filled">
                            <MudIcon Icon="@Icons.Material.Filled.Inventory" />
                        </MudAvatar>
                    </CardHeaderAvatar>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">MGW10005.DBF</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Catálogo de Productos</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.PlayArrow"
                                   OnClick="() => EjecutarDiagnostico(4)"
                                   Disabled="@(ejecutando4 || string.IsNullOrEmpty(config.Mgw10005Path))">
                            @if (ejecutando4)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                <text>Ejecutando...</text>
                            }
                            else
                            {
                                <text>Verificar</text>
                            }
                        </MudButton>
                    </CardHeaderActions>
                </MudCardHeader>
                 <MudCardContent>
                    <MudText Typo="Typo.body2" Class="mb-2">
                         <MudIcon Icon="@Icons.Material.Filled.Folder" Size="Size.Small" Class="mr-1 vertical-align-middle" Color="Color.Default" />
                         <strong>Ruta:</strong> 
                        @if (!string.IsNullOrEmpty(config.Mgw10005Path))
                        {
                            <span class="ml-1">@config.Mgw10005Path</span>
                        }
                        else
                        {
                            <MudChip T="string" Color="Color.Warning" Size="Size.Small" Class="ml-2">No configurado</MudChip>
                        }
                    </MudText>

                    @if (resultado4 != null)
                    {
                        <div class="mt-4 animate-fade-in">
                            <ComponenteDiagnostico Resultado="@resultado4" />
                        </div>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

    </MudGrid>
</MudContainer>

<style>
    .animate-fade-in {
        animation: fadeIn 0.5s ease-out;
    }
    .animate-slide-up {
        animation: slideUp 0.5s ease-out;
        animation-fill-mode: both;
    }
    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    @@keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    .vertical-align-middle {
        vertical-align: middle;
    }
</style>

@code {
    private bool ejecutando1, ejecutando2, ejecutando3, ejecutando4, ejecutandoTodos;
    private DiagnosticoResultado? resultado1, resultado2, resultado3, resultado4;
    private ConfiguracionDto config = new();

    // Columnas esperadas según el uso en el sistema
    private readonly List<string> colsPos10041 = new() { "CIDCAJA", "CSERIENOTA" };
    private readonly List<string> colsPos10042 = new() { "CFECHACOR", "CIDCAJA", "CFACTURA", "CDEVOLUCIO" };
    private readonly List<string> colsMgw10008 = new() { "CFECHA", "CIDDOCUM02", "CTOTAL", "CSERIEDO01", "CFOLIO", "CTEXTOEX03" };
    private readonly List<string> colsMgw10005 = new() { "CCODIGOP01", "CNOMBREP01", "CPRECIO1", "CIMPUESTO1" };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            config = await ConfigService.ObtenerConfiguracionAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar configuración: {ex.Message}", Severity.Error);
        }
    }

    private async Task EjecutarDiagnostico(int archivo)
    {
        try
        {
            string ruta = "";
            List<string> columnasEsperadas = new();

            switch (archivo)
            {
                case 1:
                    ruta = config.Pos10041Path;
                    columnasEsperadas = colsPos10041;
                    break;
                case 2:
                    ruta = config.Pos10042Path;
                    columnasEsperadas = colsPos10042;
                    break;
                case 3:
                    ruta = config.Mgw10008Path;
                    columnasEsperadas = colsMgw10008;
                    break;
                case 4:
                    ruta = config.Mgw10005Path;
                    columnasEsperadas = colsMgw10005;
                    break;
            }

            if (string.IsNullOrEmpty(ruta))
            {
                Snackbar.Add("No hay ruta configurada para este archivo", Severity.Warning);
                return;
            }

            switch (archivo)
            {
                case 1:
                    ejecutando1 = true;
                    resultado1 = null;
                    break;
                case 2:
                    ejecutando2 = true;
                    resultado2 = null;
                    break;
                case 3:
                    ejecutando3 = true;
                    resultado3 = null;
                    break;
                case 4:
                    ejecutando4 = true;
                    resultado4 = null;
                    break;
            }

            StateHasChanged();

            // Pequeña pausa para que la animación de carga se muestre fluidamente
            await Task.Delay(300);

            var resultado = await FoxProService.DiagnosticarArchivoAsync(ruta, columnasEsperadas);

            switch (archivo)
            {
                case 1:
                    resultado1 = resultado;
                    break;
                case 2:
                    resultado2 = resultado;
                    break;
                case 3:
                    resultado3 = resultado;
                    break;
                case 4:
                    resultado4 = resultado;
                    break;
            }

            var mensaje = resultado.Exitoso ? "Diagnóstico completado exitosamente" : "Diagnóstico completado con errores";
            var severidad = resultado.Exitoso ? Severity.Success : Severity.Error;
            Snackbar.Add(mensaje, severidad);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al ejecutar diagnóstico: {ex.Message}", Severity.Error);
        }
        finally
        {
            switch (archivo)
            {
                case 1:
                    ejecutando1 = false;
                    break;
                case 2:
                    ejecutando2 = false;
                    break;
                case 3:
                    ejecutando3 = false;
                    break;
                case 4:
                    ejecutando4 = false;
                    break;
            }
        }
    }

    private async Task EjecutarTodos()
    {
        ejecutandoTodos = true;

        await EjecutarDiagnostico(1);
        await EjecutarDiagnostico(2);
        await EjecutarDiagnostico(3);
        await EjecutarDiagnostico(4);

        ejecutandoTodos = false;

        Snackbar.Add("Todos los diagnósticos completados", Severity.Info);
    }
}