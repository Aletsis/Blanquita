@page "/añadir-caja"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@using System.ComponentModel.DataAnnotations
@using Blanquita.Application.DTOs
@using Blanquita.Application.Interfaces
@inject ICashRegisterService CashRegisterService
@inject IBranchService BranchService
@inject ILogger<AñadirCaja> Logger
@inject ISnackbar Snackbar

<MudText Typo="Typo.h3" Align="Align.Center">Añadir caja</MudText>
<EditForm Model="model" OnValidSubmit="GuardarCaja">
    <DataAnnotationsValidator />
    <MudGrid Justify="Justify.Center">
        <MudItem xs="12" sm="7">
            <MudCard>
                <MudCardContent>
                    <MudTextField @bind-Value="model.Name" Label="Nombre de caja" Variant="Variant.Text"></MudTextField>
                    <MudTextField @bind-Value="model.PrinterIp" Label="Ip Impresora" Variant="Variant.Text"></MudTextField>
                    <MudTextField @bind-Value="model.PrinterPort" Label="Puerto Impresora" Variant="Variant.Text"></MudTextField>
                    <MudSelect T="int" Label="Seleccione sucursal" @bind-Value="model.BranchId">
                        @foreach (var sucursal in sucursales)
                        {
                            <MudSelectItem T="int" Value="@sucursal.Id">@sucursal.Name</MudSelectItem>
                        }
                    </MudSelect>
                    <MudCheckBox @bind-Value="model.IsLastRegister" Label="Ultima caja" LabelPlacement="Placement.Start" Color="Color.Primary"></MudCheckBox>
                </MudCardContent>
                <MudCardActions>
                    @if (isEditing)
                    {
                        <MudButton Variant="Variant.Text" Color="Color.Error" OnClick="CancelEdit">Cancelar</MudButton>
                    }
                    <MudButton ButtonType="ButtonType.Submit"
                               Variant="Variant.Filled"
                               Color="Color.Primary"
                               Class="ml-auto">
                        @(isEditing ? "Actualizar" : "Guardar")
                    </MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>
    </MudGrid>
</EditForm>
<MudTable ServerData="ServerReload" Dense="true" Hover="true" @ref="table">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Cajas</MudText>
        <MudSpacer />
        <MudTextField T="string" ValueChanged="@(s=>OnSearch(s))" Placeholder="Buscar" Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
    </ToolBarContent>
    <HeaderContent>
        <MudTh><MudTableSortLabel SortLabel="Id" T="CashRegisterDto">Id</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="Name" T="CashRegisterDto">Nombre</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="PrinterIp" T="CashRegisterDto">Ip de impresora</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="PrinterPort" T="CashRegisterDto">Puerto impresora</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="BranchId" T="CashRegisterDto">Sucursal</MudTableSortLabel></MudTh>
        <MudTh>Ultima</MudTh>
        <MudTh>Acciones</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Id">@context.Id</MudTd>
        <MudTd DataLabel="Name">@context.Name</MudTd>
        <MudTd DataLabel="PrinterIp">@context.PrinterIp</MudTd>
        <MudTd DataLabel="PrinterPort">@context.PrinterPort</MudTd>
        <MudTd DataLabel="BranchId">@GetSucursalName(context.BranchId)</MudTd>
        <MudTd DataLabel="Ultima">@(context.IsLastRegister ? "Sí" : "No")</MudTd>
        <MudTd>
            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                           Color="Color.Primary"
                           Class="pa-0 ma-0 min-width-auto"
                           OnClick="@(() => EditCaja(context))" />
        </MudTd>
    </RowTemplate>
    <NoRecordsContent>
        <MudText>No matching records found</MudText>
    </NoRecordsContent>
    <LoadingContent>
        <MudText>Loading...</MudText>
    </LoadingContent>
    <PagerContent>
        <MudTablePager />
    </PagerContent>
</MudTable>

@code {
    private CashRegisterViewModel model = new() { BranchId = 0 };
    private bool isEditing = false;
    private int editingId = 0;
    
    private IEnumerable<BranchDto> sucursales = Enumerable.Empty<BranchDto>();
    
    private MudTable<CashRegisterDto>? table;
    private string searchString = "";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            sucursales = await BranchService.GetAllAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading branches");
            Snackbar.Add("Error al cargar sucursales", Severity.Error);
        }
    }

    private string GetSucursalName(int id) => sucursales.FirstOrDefault(s => s.Id == id)?.Name ?? id.ToString();

    private void EditCaja(CashRegisterDto selected)
    {
        editingId = selected.Id;
        model = new CashRegisterViewModel
        {
            Name = selected.Name,
            PrinterIp = selected.PrinterIp,
            PrinterPort = selected.PrinterPort,
            BranchId = selected.BranchId,
            IsLastRegister = selected.IsLastRegister
        };
        isEditing = true;
        StateHasChanged();
    }

    private void CancelEdit()
    {
        model = new CashRegisterViewModel { BranchId = 0 };
        isEditing = false;
        editingId = 0;
        StateHasChanged();
    }

    private async Task<TableData<CashRegisterDto>> ServerReload(TableState state, CancellationToken token)
    {
        try 
        {
            var data = await CashRegisterService.GetAllAsync(token);
            
            if (!string.IsNullOrWhiteSpace(searchString))
            {
                data = data.Where(c => c.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase));
            }

            var totalItems = data.Count();
            
            // Sorting (Simplistic)
            switch (state.SortLabel)
            {
                case "Name":
                    data = data.OrderByDirection(state.SortDirection, o => o.Name);
                    break;
                case "Id":
                    data = data.OrderByDirection(state.SortDirection, o => o.Id);
                    break;
            }

            var pagedData = data.Skip(state.Page * state.PageSize).Take(state.PageSize).ToArray();
            
            return new TableData<CashRegisterDto>() { TotalItems = totalItems, Items = pagedData };
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading cash registers");
            return new TableData<CashRegisterDto>() { TotalItems = 0, Items = Array.Empty<CashRegisterDto>() };
        }
    }

    private void OnSearch(string text)
    {
        searchString = text;
        table.ReloadServerData();
    }

    private async Task GuardarCaja()
    {
        try
        {
            if (isEditing)
            {
                var updateDto = new UpdateCashRegisterDto
                {
                    Id = editingId,
                    Name = model.Name,
                    PrinterIp = model.PrinterIp,
                    PrinterPort = model.PrinterPort,
                    BranchId = model.BranchId,
                    IsLastRegister = model.IsLastRegister
                };
                await CashRegisterService.UpdateAsync(updateDto);
                Snackbar.Add("Caja actualizada exitosamente", Severity.Success);
            }
            else
            {
                var createDto = new CreateCashRegisterDto
                {
                    Name = model.Name,
                    PrinterIp = model.PrinterIp,
                    PrinterPort = model.PrinterPort,
                    BranchId = model.BranchId,
                    IsLastRegister = model.IsLastRegister
                };
                await CashRegisterService.CreateAsync(createDto);
                Snackbar.Add("Caja registrada exitosamente", Severity.Success);
            }

            await table.ReloadServerData();
            CancelEdit();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al guardar la caja");
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    public class CashRegisterViewModel
    {
        [Required]
        public string Name { get; set; } = string.Empty;
        public string PrinterIp { get; set; } = string.Empty;
        public int PrinterPort { get; set; } = 9100;
        public int BranchId { get; set; }
        public bool IsLastRegister { get; set; }
    }
}
