@page "/corte-caja"
@inject IRecoService recoService
@inject ICajaService cajaService
@inject PrintJobService printJobService
@inject ISnackbar Snackbar
@inject IEncargadaService encargadaService
@inject ICajeraService cajeraService
@inject ICorteService corteService

<PageTitle>Corte de Caja</PageTitle>

<MudText Typo="Typo.h3" Align="Align.Center">Corte de caja</MudText>
<EditForm Model="corte" OnValidSubmit="HacerCorte">
    <MudGrid Justify="Justify.Center">
        <MudItem xs="12" sm="7">
            <MudCard>
                <MudCardContent>
                    <MudSelect T="int" Label="Seleccione encargada" Value="_selectedEncargada" ValueChanged="@(async (int value) => await OnEncargadaChanged(value))">
                        @if (encargadas == null)
                        {
                            <MudSelectItem T="int" Value="0">Cargando...</MudSelectItem>
                        }
                        else
                        {
                            @foreach (var _encargada in encargadas)
                            {
                                <MudSelectItem T="int" Value="@_encargada.Id">@_encargada.Nombre</MudSelectItem>
                            }
                        }
                    </MudSelect>
                    <MudSelect T="int" Label="Seleccione cajera" @bind-Value="_selectedCajera">
                        @if (cajeras == null)
                        {
                            <MudSelectItem T="int" Value="0">Cargando...</MudSelectItem>
                        }
                        else
                        {
                            @foreach (var _cajera in cajeras)
                            {
                                if (_cajera.Edo)
                                {
                                    <MudSelectItem T="int" Value="@_cajera.Id">@_cajera.Nombre</MudSelectItem>
                                }
                            }
                        }
                    </MudSelect>
                    <MudSelect T="int" Label="Seleccione caja" @bind-Value="_selectedCaja">
                        @if (cajas == null)
                        {
                            <MudSelectItem T="int" Value="0">Cargando...</MudSelectItem>
                        }
                        else
                        {
                            @foreach (var _caja in cajas)
                            {
                                <MudSelectItem T="int" Value="@_caja.Id">@_caja.Nombre</MudSelectItem>
                            }
                        }
                    </MudSelect>
                    <MudNumericField @bind-Value="totalTira" Label="Ingrese total de tira" Variant="Variant.Text" Min="0" />
                    <MudNumericField @bind-Value="totalTarjetas" Label="Ingrese total cobrado con trajeta" Variant="Variant.Text" Min="0" />
                </MudCardContent>
                <MudCardActions>
                    <MudButton ButtonType="ButtonType.Submit"
                                Variant="Variant.Filled"
                                Color="Color.Primary" 
                                Class="ml-auto"
                                Disabled="@_isSubmitting">
                                @(_isSubmitting ? "Procesando..." : "Realizar Corte")
                    </MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>
    </MudGrid>
</EditForm>

@code {
    private Cortes corte = new Cortes();
    private int _selectedCaja = 0;
    private List<Cajas>? cajas;
    private decimal totalTira = 0;
    private decimal totalTarjetas = 0;
    private int totalM = 0;
    private int totalQ = 0;
    private int totalD = 0;
    private int totalC = 0;
    private int totalCi = 0;
    private int totalV = 0;
    private int granTotal = 0;
    private List<Recolecciones> recos;
    private DateTime fecha = DateTime.Now;
    private Cajas _cajaSeleccionada;
    private int segundaOpcion;
    private string sucursal;
    private int _selectedEncargada = 0;
    private int _selectedCajera = 0;
    private List<Encargadas>? encargadas;
    private List<Cajeras>? cajeras;
    private Encargadas _encargadaSeleccionada;
    private Cajeras _cajeraSeleccionada;
    private bool _isSubmitting = false;

    protected override async Task OnInitializedAsync()
    {
        encargadas = await encargadaService.ObtenerEncargadas();
        cajeras = new List<Cajeras>();
        cajas = new List<Cajas>();
    }

    private async Task OnEncargadaChanged(int encargadaId)
    {
        _selectedEncargada = encargadaId;
        _selectedCajera = 0; // Resetear cajera seleccionada
        _selectedCaja = 0;    // Resetear caja seleccionada

        if (encargadaId > 0)
        {
            _encargadaSeleccionada = await encargadaService.EncontrarEncargadaPorId(encargadaId);
            cajas = await cajaService.EncontrarCajasPorSucursal(_encargadaSeleccionada.Sucursal);

            // También puedes filtrar cajeras por sucursal si es necesario
            cajeras = await cajeraService.EncontrarCajerasPorSucursal(_encargadaSeleccionada.Sucursal); // O implementa un filtro similar
        }
        else
        {
            cajas = new List<Cajas>();
            cajeras = new List<Cajeras>();
        }

        StateHasChanged();
    }
    private async Task HacerCorte()
    {
        if (_isSubmitting) return;
        if (_selectedEncargada == 0 || _selectedCajera == 0 || _selectedCaja == 0)
        {
            Snackbar.Add("❗ Debe seleccionar encargada, cajera y caja.", Severity.Warning);
            return;
        }
        _isSubmitting = true;
        try
        {
            // 1. Calcular totales de las recolecciones
            totalM = 0;
            totalQ = 0;
            totalD = 0;
            totalC = 0;
            totalCi = 0;
            totalV = 0;
            granTotal = 0;

            // Obtener solo recolecciones de la caja seleccionada
            recos = (await recoService.RecosPorFecha(fecha))
                   .Where(r => r.Caja == _selectedCaja.ToString() && !r.Corte)
                   .ToList();

            foreach (var tRecos in recos)
            {
                totalM += tRecos.Mil;
                totalQ += tRecos.Quinientos;
                totalD += tRecos.Doscientos;
                totalC += tRecos.Cien;
                totalCi += tRecos.Cincuenta;
                totalV += tRecos.Veinte;
                granTotal += tRecos.CantidadTotal;
            }

            // 2. Marcar todas las recolecciones de esta caja como con corte
            var recoleccionesMarcadas = await recoService.HacerCorteAsync(_selectedCaja.ToString());
            // 3. Imprimir ticket de corte
            try
            {
                switch (_encargadaSeleccionada.Sucursal)
                {
                    case 6:
                        sucursal = "Himno Nacional";
                        break;
                    case 7:
                        sucursal = "Pozos";
                        break;
                    case 8:
                        sucursal = "Soledad";
                        break;
                    case 9:
                        sucursal = "Saucito";
                        break;
                    case 10:
                        sucursal = "Chapultepec";
                        break;
                }
                _cajeraSeleccionada = await cajeraService.EncontrarCajeraPorId(_selectedCajera);
                _encargadaSeleccionada = await encargadaService.EncontrarEncargadaPorId(_selectedEncargada);
                _cajaSeleccionada = await cajaService.EncontrarCajaPorId(_selectedCaja);

                corte = new Cortes
                    {
                        TotalM = totalM,
                        TotalQ = totalQ,
                        TotalD = totalD,
                        TotalC = totalC,
                        TotalCi = totalCi,
                        TotalV = totalV,
                        TotalTira = totalTira,
                        TotalTarjetas = totalTarjetas,
                        GranTotal = granTotal,
                        Caja = _cajaSeleccionada.Nombre,
                        Encargada = _encargadaSeleccionada.Nombre,
                        Cajera = _cajeraSeleccionada.Nombre,
                        Sucursal = sucursal,
                        FechaHora = DateTime.Now
                    };

                await corteService.GuardarCorte(corte);

                var printData = new PrintCorteData
                    {
                        TotalM = totalM,
                        TotalQ = totalQ,
                        TotalD = totalD,
                        TotalC = totalC,
                        TotalCi = totalCi,
                        TotalV = totalV,
                        TotalTira = totalTira,
                        TotalTarjetas = totalTarjetas,
                        GranTotal = granTotal,
                        Caja = _cajaSeleccionada.Nombre,
                        Encargada = _encargadaSeleccionada.Nombre,
                        Cajera = _cajeraSeleccionada.Nombre,
                        Sucursal = sucursal,
                        FechaHora = DateTime.Now
                    };
                try
                {
                    await printJobService.PrintCorteCajaAsync(_selectedCaja, printData);
                    Snackbar.Add("✅ Corte impreso correctamente", Severity.Success);
                }
                catch
                {
                    // Lógica de respaldo: cambiar a otra impresora
                    int respaldoId = _cajaSeleccionada.Ultima ? _selectedCaja - 1 : _selectedCaja + 1;
                    try
                    {
                        var respaldo = await cajaService.EncontrarCajaPorId(respaldoId);
                        if (respaldo != null)
                        {
                            await printJobService.PrintCorteCajaAsync(respaldo.Id, printData);
                            Snackbar.Add($"⚠️ Impresión con respaldo: {respaldo.Nombre}", Severity.Warning);
                        }
                        else
                        {
                            Snackbar.Add("❌ No se encontró impresora de respaldo.", Severity.Error);
                        }
                    }
                    catch (Exception e2)
                    {
                        Snackbar.Add($"❌ Error al imprimir corte en impresora principal y respaldo: {e2.Message}", Severity.Error);
                    }
                }
            }
            catch (Exception e)
            {
                Snackbar.Add($"❌ Error general al realizar el corte: {e.Message}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"❌ Error general al realizar el corte: {ex.Message}", Severity.Error);
        }
        finally
        {
            ResetForm();
            _isSubmitting = false;
            StateHasChanged();
        }
    }
    private void ResetForm()
    {
        _selectedEncargada = 0;
        _selectedCajera = 0;
        _selectedCaja = 0;
        totalTira = 0;
        totalTarjetas = 0;
    }
}