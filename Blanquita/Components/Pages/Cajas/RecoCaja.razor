@page "/recoleccion"
@using System.Threading
@inject PrintJobService printJobService
@inject ICajaService cajaService
@inject ICajeraService cajeraService
@inject IEncargadaService encargadaService
@inject IRecoService recoService
@inject ISnackbar Snackbar

<PageTitle>Recoleccion</PageTitle>

<MudText Typo="Typo.h3">Recoleccion de efectivo</MudText>
    <MudGrid>
    @if (_isError && !string.IsNullOrEmpty(_errorMessage))
    {
        <MudItem xs="12">
            <MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
        </MudItem>
    }

    <!-- Mostrar mensaje de éxito -->
    @if (!_isError && _isSubmitting)
    {
        <MudItem xs="12">
            <MudAlert Severity="Severity.Info">Procesando recolección...</MudAlert>
        </MudItem>
    }
        <MudItem xs="12" sm="6">
            <MudCard>
                <MudCardContent>
                    <MudSelect T="int" Label="Seleccione encargada" Value="_selectedEncargada" ValueChanged="@(async (int value) => await OnEncargadaChanged(value))">
                    @if (encargadas == null)
                    {
                        <MudSelectItem T="int" Value="0">Cargando...</MudSelectItem>
                    }
                    else
                    {
                        @foreach (var _encargada in encargadas)
                        {
                            <MudSelectItem T="int" Value="@_encargada.Id">@_encargada.Nombre</MudSelectItem>
                        }
                    }
                    </MudSelect>
                    <MudSelect T="int" Label="Seleccione cajera" @bind-Value="_selectedCajera">
                        @if (cajeras == null)
                        {
                            <MudSelectItem T="int" Value="0">Cargando...</MudSelectItem>
                        }
                        else
                        {
                            @foreach (var _cajera in cajeras)
                            {
                                if(_cajera.Edo)
                                {
                                <MudSelectItem T="int" Value="@_cajera.Id">@_cajera.Nombre</MudSelectItem>
                                }
                            }
                        }
                    </MudSelect>
                    <MudSelect T="int" Label="Seleccione caja" @bind-Value="_selectedCaja">
                        @if (cajas == null)
                        {
                            <MudSelectItem T="int" Value="0">Cargando...</MudSelectItem>
                        }
                        else
                        {
                            @foreach (var _caja in cajas)
                            {
                                <MudSelectItem T="int" Value="@_caja.Id">@_caja.Nombre</MudSelectItem>
                            }
                        }
                    </MudSelect>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6">
            <MudCard>
                <MudCardContent>
                    <MudNumericField @bind-Value="_c1000" Label="$1000" Variant="Variant.Text" Min="0" />
                    <MudNumericField @bind-Value="_c500" Label="$500" Variant="Variant.Text" Min="0" />
                    <MudNumericField @bind-Value="_c200" Label="$200" Variant="Variant.Text" Min="0" />
                    <MudNumericField @bind-Value="_c100" Label="$100" Variant="Variant.Text" Min="0" />
                    <MudNumericField @bind-Value="_c50" Label="$50" Variant="Variant.Text" Min="0" />
                    <MudNumericField @bind-Value="_c20" Label="$20" Variant="Variant.Text" Min="0" />
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.button">Total:</MudText>
                        <MudPaper Class="pa-3">
                            <MudText Typo="Typo.button">$ @(_c1000 * 1000 + _c500 * 500 + _c200 * 200 + _c100 * 100 + _c50 * 50 + _c20 * 20).00</MudText>
                        </MudPaper>
                    </MudStack>
            </MudCardContent>
            <MudCardActions>
                <MudStack Spacing="2">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="@ImprimirReco"
                               Disabled="@_isSubmitting">
                        @(_isSubmitting ? "Procesando..." : "Imprimir")
                    </MudButton>
                </MudStack>
            </MudCardActions>
            </MudCard>
        </MudItem>
    </MudGrid>

@code {
    private int _selectedEncargada = 0;
    private List<Encargadas>? encargadas;
    private int _selectedCajera = 0;
    private List<Cajeras>? cajeras;
    private int _selectedCaja = 0;
    private List<Cajas>? cajas;
    private int _c1000 = 0;
    private int _c500 = 0;
    private int _c200 = 0;
    private int _c100 = 0;
    private int _c50 = 0;
    private int _c20 = 0;
    private int _t1000 = 0;
    private int _t500 = 0;
    private int _t200 = 0;
    private int _t100 = 0;
    private int _t50 = 0;
    private int _t20 = 0;
    private int _total = 0;
    private bool _isError = false;
    private Recolecciones recoleccion;
    private Cajas _cajaSeleccionada;
    private Cajeras _cajeraSeleccionada;
    private Encargadas _encargadaSeleccionada;
    private bool _isSubmitting = false;
    private string _errorMessage = string.Empty;
    private int segundaOpcion;
    private string sucursal;

    private bool ValidateForm()
    {
        if (_selectedEncargada == 0)
        {
            Snackbar.Add("❗Seleccione una encargada", Severity.Warning);
            return false;
        }

        if (_selectedCajera == 0)
        {
            _errorMessage = "Seleccione una cajera";
            return false;
        }

        if (_selectedCaja == 0)
        {
            _errorMessage = "Seleccione una caja";
            return false;
        }

        if (_total <= 0)
        {
            _errorMessage = "El monto total debe ser mayor a cero";
            return false;
        }

        _errorMessage = string.Empty;
        return true;
    }

    protected override async Task OnInitializedAsync()
    {
        encargadas = await encargadaService.ObtenerEncargadas();
        cajeras = new List<Cajeras>();
        cajas = new List<Cajas>();
    }

    private async Task OnEncargadaChanged(int encargadaId)
    {
        _selectedEncargada = encargadaId;
        _selectedCajera = 0; // Resetear cajera seleccionada
        _selectedCaja = 0;    // Resetear caja seleccionada

        if (encargadaId > 0)
        {
            _encargadaSeleccionada = await encargadaService.EncontrarEncargadaPorId(encargadaId);
            cajas = await cajaService.EncontrarCajasPorSucursal(_encargadaSeleccionada.Sucursal);

            // También puedes filtrar cajeras por sucursal si es necesario
            cajeras = await cajeraService.EncontrarCajerasPorSucursal(_encargadaSeleccionada.Sucursal); // O implementa un filtro similar
        }
        else
        {
            cajas = new List<Cajas>();
            cajeras = new List<Cajeras>();
        }

        StateHasChanged();
    }

    private async Task ImprimirReco()
    {
        if (_isSubmitting) return;

        _isSubmitting = true;
        _errorMessage = string.Empty;
        try
        {
            _t1000 = _c1000 * 1000;
            _t500 = _c500 * 500;
            _t200 = _c200 * 200;
            _t100 = _c100 * 100;
            _t50 = _c50 * 50;
            _t20 = _c20 * 20;
            _total = _t1000 + _t500 + _t200 + _t100 + _t50 + _t20;
            if (!ValidateForm())
            {
                _isError = true;
                StateHasChanged();
                return;
            }
            recoleccion = new()
                {
                    CantidadTotal = _total,
                    Mil = _c1000,
                    Quinientos = _c500,
                    Doscientos = _c200,
                    Cien = _c100,
                    Cincuenta = _c50,
                    Veinte = _c20,
                    Caja = _selectedCaja.ToString(),
                    Cajera = _selectedCajera.ToString(),
                    Encargada = _selectedEncargada.ToString(),
                    FechaHora = DateTime.Now
                };
            _isError = false;
            StateHasChanged();
            _cajaSeleccionada = await cajaService.EncontrarCajaPorId(_selectedCaja);
            _cajeraSeleccionada = await cajeraService.EncontrarCajeraPorId(_selectedCajera);
            _encargadaSeleccionada = await encargadaService.EncontrarEncargadaPorId(_selectedEncargada);
            switch (_encargadaSeleccionada.Sucursal)
            {
                case 6:
                    sucursal = "Himno Nacional";
                    break;
                case 7:
                    sucursal = "Pozos";
                    break;
                case 8:
                    sucursal = "Soledad";
                    break;
                case 9 :
                    sucursal = "Saucito";
                    break;
                case 10:
                    sucursal = "Chapultepec";
                    break;
            }
            // Guardar la recolección (el folio se asignará automáticamente en el servicio)
            var recoleccionGuardada = await recoService.CrearRecoleccionAsync(recoleccion);
            var printData = new PrintTicketData
                {
                    CantMil = _c1000,
                    CantQuinientos = _c500,
                    CantDoscientos = _c200,
                    CantCien = _c100,
                    CantCincuenta = _c50,
                    CantVeinte = _c20,
                    Caja = _cajaSeleccionada.Nombre,
                    Cajera = _cajeraSeleccionada.Nombre,
                    Encargada = _encargadaSeleccionada.Nombre,
                    Folio = recoleccionGuardada.Folio,
                    Sucursal = sucursal
                };
            try
            {
                
                await printJobService.PrintTicketAsync(_cajaSeleccionada.Id, printData);
                Snackbar.Add("✅ Recoleccion impresa correctamente", Severity.Success);
            }
            catch
            {
                _isError = true;
                _errorMessage = $"Error al conectar con impresora reintentando imprimir en impresora: {_cajaSeleccionada.Nombre}...";
                int respaldoId = _cajaSeleccionada.Ultima ? _selectedCaja - 1 : _selectedCaja + 1;
                try
                {
                    Thread.Sleep(5000);
                    var respaldo = await cajaService.EncontrarCajaPorId(respaldoId);
                    if (respaldo != null)
                    {
                        await printJobService.PrintTicketAsync(respaldo.Id, printData);
                        Snackbar.Add($"⚠️ Impresión con respaldo: {respaldo.Nombre}", Severity.Warning);
                    }
                    else
                    {
                        Snackbar.Add("❌ No se encontró impresora de respaldo.", Severity.Error);
                    }
                }
                catch (Exception e)
                {
                    _errorMessage = $"Error al Imprimir contacte a sistemas";
                    _isError = true;
                }
            }

            ResetForm();
            _isError = false;
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error al procesar la recolección: {ex.Message}";
            _isError = true;
        }
        finally
        {
            _isSubmitting = false;
            StateHasChanged();
        }
    }
    private void ResetForm()
    {
        _selectedEncargada = 0;
        _selectedCajera = 0;
        _selectedCaja = 0;
        _c1000 = 0;
        _c500 = 0;
        _c200 = 0;
        _c100 = 0;
        _c50 = 0;
        _c20 = 0;
        _t1000 = 0;
        _t500 = 0;
        _t200 = 0;
        _t100 = 0;
        _t50 = 0;
        _t20 = 0;
        _total = 0;
    }
}
