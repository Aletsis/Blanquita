@page "/etiquetas"
@inject FileConfigService fileConfigService
@inject IFoxProService FoxProService
@inject ISnackbar Snackbar
@inject IZebraPrinterService zebraPrinterService
@inject IDialogService DialogService
@inject ILogger<ImprimirEtiquetas> Logger

<PageTitle>Imprimir Etiquetas</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">
    <MudIcon Icon="@Icons.Material.Filled.Receipt" Class="mr-2" />
    Imprimir Etiquetas
</MudText>

<MudGrid>
    <MudItem xs="12" md="4">
        <MudPaper Elevation="2" Class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-4">
                <MudIcon Icon="@Icons.Material.Filled.FilterAlt" Size="Size.Small" Class="mr-2" />
                Codigo del Producto
            </MudText>
            <MudTextField @bind-Value="barcodeText"
                          OnKeyUp="BuscarProductoConEnter"
                          Label="Codigo"
                          Variant="Variant.Outlined"
                          ReadOnly="false"
                          Adornment="Adornment.End"
                          AdornmentIcon="@Icons.Material.Filled.LabelImportant"
                          Class="mb-2" />
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       FullWidth="true"
                       StartIcon="@Icons.Material.Filled.Search"
                       OnClick="BuscarProducto"
                       Disabled="@(buscando || string.IsNullOrEmpty(barcodeText))"
                       Size="Size.Large">
                @if (buscando)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <text>Buscando...</text>
                }
                else
                {
                    <text>Buscar Producto</text>
                }
            </MudButton>
            @if (productoEncontrado)
            {
                <MudDivider Class="my-3" />
                <MudText Typo="Typo.subtitle1" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.Print" Size="Size.Small" Class="mr-2" />
                    Seleccione impresora
                </MudText>
                <MudSelect T="int" Label="Impresora" @bind-Value="selectedPrinter" Variant="Variant.Outlined" Class="my-2">
                    <MudSelectItem Value="1">@fileConfigService.Config.PrinterName</MudSelectItem>
                    <MudSelectItem Value="2">@fileConfigService.Config.Printer2Name</MudSelectItem>
                </MudSelect>
                <MudText Typo="Typo.subtitle1" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Class="mr-2" />
                    Cantidad a Imprimir
                </MudText>
                <MudNumericField @bind-Value="cantidadEtiquetas"
                                 Label="Cantidad a Imprimir"
                                 Variant="Variant.Outlined"
                                 Adornment="Adornment.Start"
                                 AdornmentIcon="@Icons.Material.Filled.Numbers"
                                 Class="mb-2" />
                <MudButton Variant="Variant.Outlined"
                           StartIcon="@Icons.Material.Filled.Download"
                           Color="Color.Success"
                           OnClick="Imprimir"
                           Size="Size.Small">
                    Imprimir
                </MudButton>
            }
        </MudPaper>
    </MudItem>
    <MudItem xs="12" md="8">
        @if (buscando)
        {
            <MudPaper Elevation="2" Class="pa-8 text-center">
                <MudProgressCircular Size="Size.Large" Indeterminate="true" />
                <MudText Typo="Typo.h6" Class="mt-4">Buscando Producto...</MudText>
            </MudPaper>
        }
        else if (busquedaTerminada && producto != null)
        {
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            @producto["CNOMBREP01"]
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudText Typo="Typo.h5">
                        $@valorRedondeado
                    </MudText>
                </MudCardContent>
            </MudCard>
        }
        else
        {
            <MudPaper Elevation="2" Class="pa-8 text-center" Style="min-height: 400px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                <MudIcon Icon="@Icons.Material.Filled.Assessment" Size="Size.Large" Color="Color.Secondary" />
                <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mt-4">
                    Ingrese el codigo del producto
                </MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Despues ingrese el numero de etiquetas a imprimir
                </MudText>
            </MudPaper>
        }
    </MudItem>
</MudGrid>

@code {
    private string barcodeText;
    private bool buscando = false;
    private bool productoEncontrado = false;
    private bool busquedaTerminada = false;
    private int cantidadEtiquetas;
    private Dictionary<string, object> producto;
    private string precio;
    private decimal valorRedondeado;
    private int selectedPrinter = 1;
    private string printerIp = "";
    private int printerPort = 9100;
    private string zplPreview = "";
    private LabelDesign labelDesign = new LabelDesign();
    private string labelTitle;
    private string productPrice;
    private string labelFooter = DateTime.Now.ToString("yyyy-MM-dd");

    private async Task BuscarProducto()
    {
        productoEncontrado = false;
        busquedaTerminada = false;
        buscando = true;
        
        Logger.LogInformation("Iniciando búsqueda de producto con código: {CodigoProducto}", barcodeText);
        
        try
        {
            StateHasChanged();
            producto = await Task.Run(() => FoxProService.BuscarProducto(barcodeText));
            
            if (producto != null)
            {
                productoEncontrado = true;
                CalcularPrecioConImpuesto();
                
                Logger.LogInformation("Producto encontrado: {NombreProducto}, Precio: {Precio:C2}", 
                    producto["CNOMBREP01"], valorRedondeado);
            }
            else
            {
                Logger.LogWarning("Producto no encontrado para código: {CodigoProducto}", barcodeText);
                Snackbar.Add("Producto no encontrado", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al buscar producto con código: {CodigoProducto}", barcodeText);
            Snackbar.Add($"Error al buscar producto: {ex.Message}", Severity.Error);
        }
        finally
        {
            buscando = false;
            busquedaTerminada = true;
            StateHasChanged();
        }
    }

    private void CalcularPrecioConImpuesto()
    {
        if (producto == null) return;

        var impuesto = Convert.ToInt32(producto["CIMPUESTO1"]);
        var precio = Convert.ToDecimal(producto["CPRECIO1"]);
        
        if (impuesto > 0)
        {
            var impuestoDecimal = impuesto / 100m;
            precio = precio * (1 + impuestoDecimal);
            Logger.LogDebug("Precio calculado con impuesto {Impuesto}%: {PrecioOriginal:C2} -> {PrecioFinal:C2}", 
                impuesto, Convert.ToDecimal(producto["CPRECIO1"]), precio);
        }
        
        valorRedondeado = Math.Round(precio, 2, MidpointRounding.AwayFromZero);
        labelTitle = producto["CNOMBREP01"].ToString();
        productPrice = valorRedondeado.ToString();
    }

    private async Task BuscarProductoConEnter(KeyboardEventArgs args)
    {
        if (args.Key == "Enter")
        {
            await BuscarProducto();
        }
    }

    private async Task Imprimir()
    {
        if (cantidadEtiquetas <= 0)
        {
            Logger.LogWarning("Intento de impresión con cantidad inválida: {Cantidad}", cantidadEtiquetas);
            Snackbar.Add("Cantidad de etiquetas debe ser mayor a 0", Severity.Warning);
            return;
        }

        var printerName = selectedPrinter == 1 ? fileConfigService.Config.PrinterName : fileConfigService.Config.Printer2Name;
        
        Logger.LogInformation("Iniciando impresión de {Cantidad} etiquetas para producto {CodigoProducto} en impresora {Impresora}", 
            cantidadEtiquetas, barcodeText, printerName);

        if (selectedPrinter == 1)
        {
            printerIp = fileConfigService.Config.PrinterIp;
            printerPort = Convert.ToInt32(fileConfigService.Config.PrinterPort);
        }
        else
        {
            printerIp = fileConfigService.Config.Printer2Ip;
            printerPort = Convert.ToInt32(fileConfigService.Config.Printer2Port);
        }
        
        try
        {
            zplPreview = zebraPrinterService.GenerateLabel(labelDesign, labelTitle, barcodeText, productPrice, labelFooter, cantidadEtiquetas);
            await zebraPrinterService.PrintViaNetwork(printerIp, printerPort, zplPreview);
            
            var mensaje = cantidadEtiquetas == 1 ? "Etiqueta enviada a impresora" : "Etiquetas enviadas a impresora";
            
            Logger.LogInformation("Impresión completada exitosamente. {Cantidad} etiquetas enviadas a {Impresora} ({IP}:{Puerto})", 
                cantidadEtiquetas, printerName, printerIp, printerPort);
            
            Snackbar.Add(mensaje, Severity.Success);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al imprimir {Cantidad} etiquetas en impresora {Impresora} ({IP}:{Puerto})", 
                cantidadEtiquetas, printerName, printerIp, printerPort);
            
            Snackbar.Add($"Error al imprimir etiquetas: {ex.Message}", Severity.Error);
        }
    }
}
