@page "/barcode-scanner"
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<div class="scanner-container">
    <h3>Escáner de Códigos de Barras</h3>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }

    @if (!isScanning)
    {
        <button class="btn btn-primary" @onclick="StartScanning">
            Iniciar Escáner
        </button>
    }
    else
    {
        <button class="btn btn-danger" @onclick="StopScanning">
            Detener Escáner
        </button>
    }

    <div class="video-container" style="display: @(isScanning ? "block" : "none")">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" style="display: none;"></canvas>
    </div>

    @if (!string.IsNullOrEmpty(lastScannedCode))
    {
        <div class="result">
            <h4>Código escaneado:</h4>
            <p class="code-result">@lastScannedCode</p>
            <p class="format">Formato: @lastFormat</p>
        </div>
    }
</div>

<style>
    .scanner-container {
        max-width: 600px;
        margin: 20px auto;
        padding: 20px;
    }

    .video-container {
        margin: 20px 0;
        position: relative;
    }

    #video {
        width: 100%;
        max-width: 500px;
        border: 2px solid #007bff;
        border-radius: 8px;
    }

    .result {
        margin-top: 20px;
        padding: 15px;
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 5px;
    }

    .code-result {
        font-size: 1.5em;
        font-weight: bold;
        color: #155724;
    }

    .format {
        color: #155724;
        font-style: italic;
    }

    .btn {
        padding: 10px 20px;
        font-size: 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
    }

    .btn-primary {
        background-color: #007bff;
        color: white;
    }

    .btn-danger {
        background-color: #dc3545;
        color: white;
    }

    .alert {
        padding: 12px;
        margin: 10px 0;
        border-radius: 5px;
    }

    .alert-danger {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
</style>

@code {
    private bool isScanning = false;
    private string lastScannedCode = string.Empty;
    private string lastFormat = string.Empty;
    private string errorMessage = string.Empty;
    private DotNetObjectReference<BarcodeScannerComponent>? objRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(new BarcodeScannerComponent(this));
            await JSRuntime.InvokeVoidAsync("initBarcodeScanner", objRef);
        }
    }

    private async Task StartScanning()
    {
        try
        {
            errorMessage = string.Empty;
            await JSRuntime.InvokeVoidAsync("startScanning");
            isScanning = true;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al iniciar el escáner: {ex.Message}";
        }
    }

    private async Task StopScanning()
    {
        await JSRuntime.InvokeVoidAsync("stopScanning");
        isScanning = false;
    }

    public void OnBarcodeDetected(string code, string format)
    {
        lastScannedCode = code;
        lastFormat = format;
        StateHasChanged();
    }

    public void OnError(string message)
    {
        errorMessage = message;
        isScanning = false;
        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        if (isScanning)
        {
            await StopScanning();
        }
        objRef?.Dispose();
    }

    public class BarcodeScannerComponent
    {
        private readonly BarcodeScanner _parent;

        public BarcodeScannerComponent(BarcodeScanner parent)
        {
            _parent = parent;
        }

        [JSInvokable]
        public void OnBarcodeDetected(string code, string format)
        {
            _parent.OnBarcodeDetected(code, format);
        }

        [JSInvokable]
        public void OnError(string message)
        {
            _parent.OnError(message);
        }
    }
}